import{getInstance as v,getInterface as g,setRO as j}from"./runtime.esm.js";import{NANOS as y}from"./vendor.esm.js";const d=t=>t,w=t=>{throw t},p=t=>typeof t=="function"&&(!t.msjsType||t.msjsType==="@code"||t.msjsType==="@function"),O=t=>typeof t?.then=="function",l=Symbol(),m=t=>Object.assign(new y(t),t);function h(t){const{state:e,result:r}=this[l],s=e==="fulfilled";if(!s&&!t.length){queueMicrotask(()=>Promise.reject(r));return}for(const i of t){const[n,a,o]=i;queueMicrotask(()=>{try{const c=s?n:a,f=c.msjsType;f?o.resolve(c(f==="@code"?"run":"call",s?{resolve:r}:{reject:r})):o.resolve(c(r))}catch(c){o.reject(c)}})}}const u=Object.setPrototypeOf({all(t){if(this[l].state!=="pending")return;const e=[];let r=t.length;return r||this.resolve(e),t.forEach((s,i)=>{s.then(n=>{e[i]=n,--r===0&&this.resolve(e)},n=>this.reject(n))}),this},allSettled(t){if(this[l].state!=="pending")return;const e=[];let r=t.length;return r||this.resolve(e),t.forEach((s,i)=>{s.then(n=>{e[i]=m({status:"fulfilled",value:n}),--r===0&&this.resolve(e)},n=>{e[i]=m({status:"rejected",reason:n}),--r===0&&this.resolve(e)})}),this},always(t){return this.then(t,t)},any(t){if(this[l].state!=="pending")return;const e=[];let r=t.length;const s=()=>{throw new AggregateError(e,"All promises were rejected")};return r||s(),t.forEach((i,n)=>{i.then(a=>this.resolve(a),a=>{e[n]=a,--r===0&&s()})}),this},catch(t){return this.then(null,t)},then(t,e){const r=this[l];p(t)||(t=d),p(e)||(e=w);const s=[t,e,v("@promise")];return r.handlers?r.handlers.push(s):queueMicrotask(()=>h.call(this,[s])),s[2]},race(t){if(this[l].state==="pending")return t.forEach(e=>e.then(r=>this.resolve(r),r=>this.reject(r))),this},reject(t){const e=this[l];e.state==="pending"&&(e.state="rejected",t instanceof Error||(t=new Error(t)),e.result=t,queueMicrotask(()=>{h.call(this,e.handlers),e.handlers=null}))},resolve(t){const e=this[l];if(e.state==="pending"){if(O(t)){t.then(r=>this.resolve(r),r=>this.reject(r));return}e.state="fulfilled",e.result=t,queueMicrotask(()=>{h.call(this,e.handlers),e.handlers=null})}},get result(){return this[l].result},get state(){return this[l].state}},Object.getPrototypeOf(Function));u.finally=u.always;function b(t){Object.setPrototypeOf(t.rr,u),j(t.rr,l,{state:"pending",result:void 0,handlers:[]}),t.mp.has("resolve")&&t.rr.resolve(t.mp.at("resolve")),t.mp.has("reject")&&t.rr.reject(t.mp.at("reject"))}function S(t){g(t).set({lock:!0,pristine:!0,handlers:{"@init":b,all:e=>e.rr.all(e.mp.values()),allSettled:e=>e.rr.allSettled(e.mp.values()),always:e=>e.rr.always(e.mp.at(0)),any:e=>e.rr.any(e.mp.values()),catch:e=>e.rr.catch(e.mp.at(0)),race:e=>e.rr.race(e.mp.values()),reject:e=>e.rr.reject(e.mp.at(0)),resolve:e=>e.rr.resolve(e.mp.at(0)),result:e=>e.rr.result,state:e=>e.rr.state,then:e=>e.rr.then(e.mp.at(0),e.mp.at(1))}})}export{S as install};
