{
  "version": 3,
  "sources": ["../../src/runtime/msjs-promise.esm.js"],
  "sourcesContent": ["/*\n * Mesgjs @promise interface\n * (Implements Promise-like API, but is NOT a JS Promise wrapper interface)\n *\n * Authors: Brian Katzung <briank@kappacs.com> and ChatGPT\n * Copyright 2025 by Kappa Computer Solutions, LLC and Brian Katzung\n */\n\n/*\nCan reject in the original promise task, but queues the handler call (it\ndoesn't require the handler yet).\nIt returns.\nHandlers can be added in a chain after the new Promise.\nIn the reject dispatch, checks for no reject handler.\n*/\n\nimport { getInstance, getInterface, setRO } from './runtime.esm.js';\nimport { NANOS } from './vendor.esm.js';\n\nconst identity = x => x, thrower = x => { throw x; };\nconst callable = f => typeof f === 'function' && (!f.msjsType || f.msjsType === '@code' || f.msjsType === '@function');\nconst thenable = o => typeof o?.then === 'function';\nconst privKey = Symbol();\nconst dualStatus = status => Object.assign(new NANOS(status), status);\n\nfunction callHandlers (list) {\n    const { state, result } = this[privKey], ok = state === 'fulfilled';\n    if (!ok && !list.length) {\n\tqueueMicrotask(() => Promise.reject(result));\n\treturn;\n    }\n    for (const entry of list) {\n\tconst [ onResolve, onReject, next ] = entry;\n\tqueueMicrotask(() => {\n\t    try {\n\t\tconst handler = ok ? onResolve : onReject, st = handler.msjsType;\n\t\tif (st) next.resolve(handler((st === '@code') ? 'run' : 'call', ok ? { resolve: result } : { reject: result }));\n\t\telse next.resolve(handler(result));\n\t    } catch (err) {\n\t\tnext.reject(err);\n\t    }\n\t});\n    }\n}\n\nconst proto = Object.setPrototypeOf({\n    // Resolve all of a set of promises with an array of their results\n    all (promises) {\n\tif (this[privKey].state !== 'pending') return;\n\tconst results = [];\n\tlet remaining = promises.length;\n\n\tif (!remaining) this.resolve(results);\n\tpromises.forEach((p, idx) => {\n\t    p.then(res => {\n\t\tresults[idx] = res;\n\t\tif (--remaining === 0) this.resolve(results);\n\t    }, err => this.reject(err));\n\t});\n\treturn this;\n    },\n\n    allSettled (promises) {\n\tif (this[privKey].state !== 'pending') return;\n\tconst results = [];\n\tlet remaining = promises.length;\n\n\tif (!remaining) this.resolve(results);\n\tpromises.forEach((p, idx) => {\n\t    p.then(value => {\n\t\tresults[idx] = dualStatus({ status: 'fulfilled', value });\n\t\tif (--remaining === 0) this.resolve(results);\n\t    }, reason => {\n\t\tresults[idx] = dualStatus({ status: 'rejected', reason });\n\t\tif (--remaining === 0) this.resolve(results);\n\t    });\n\t});\n\treturn this;\n    },\n\n    always (handler) { return this.then(handler, handler); },\n\n    any (promises) {\n\tif (this[privKey].state !== 'pending') return;\n\tconst reasons = [];\n\tlet remaining = promises.length;\n\tconst allRejected = () => { throw new AggregateError(reasons, 'All promises were rejected'); };\n\n\tif (!remaining) allRejected();\n\tpromises.forEach((p, idx) => {\n\t    p.then(res => this.resolve(res), reason => {\n\t\treasons[idx] = reason;\n\t\tif (--remaining === 0) allRejected();\n\t    });\n\t});\n\treturn this;\n    },\n\n    catch (onReject) { return this.then(null, onReject); },\n\n    then (onResolve, onReject) {\n\tconst priv = this[privKey];\n\tif (!callable(onResolve)) onResolve = identity;\n\tif (!callable(onReject)) onReject = thrower;\n\tconst entry = [ onResolve, onReject, getInstance('@promise') ];\n\tif (priv.handlers) priv.handlers.push(entry);\n\telse queueMicrotask(() => callHandlers.call(this, [ entry ]));\n\treturn entry[2];\n    },\n\n    race (promises) {\n\tif (this[privKey].state !== 'pending') return;\n\tpromises.forEach(p => p.then(res => this.resolve(res), err => this.reject(err)));\n\treturn this;\n    },\n\n    reject (reason) {\n\tconst priv = this[privKey];\n\tif (priv.state !== 'pending') return;\n\tpriv.state = 'rejected';\n\tif (!(reason instanceof Error)) reason = new Error(reason);\n\tpriv.result = reason;\n\tqueueMicrotask(() => {\n\t    callHandlers.call(this, priv.handlers);\n\t    priv.handlers = null;\n\t});\n    },\n\n    resolve (result) {\n\tconst priv = this[privKey];\n\tif (priv.state !== 'pending') return;\n\tif (thenable(result)) {\n\t    result.then(res => this.resolve(res), err => this.reject(err));\n\t    return;\n\t}\n\tpriv.state = 'fulfilled';\n\tpriv.result = result;\n\tqueueMicrotask(() => {\n\t    callHandlers.call(this, priv.handlers);\n\t    priv.handlers = null;\n\t});\n    },\n\n    get result () { return this[privKey].result; },\n\n    get state () { return this[privKey].state; },\n\n}, Object.getPrototypeOf(Function));\nproto.finally = proto.always;\n\nfunction opInit (d) {\n    // Initialize, and make this object JS/Mesgjs \"bilingual\"\n    Object.setPrototypeOf(d.rr, proto);\n    setRO(d.rr, privKey, {\n\tstate: 'pending', result: undefined, handlers: [],\n    });\n    if (d.mp.has('resolve')) d.rr.resolve(d.mp.at('resolve'));\n    if (d.mp.has('reject')) d.rr.reject(d.mp.at('reject'));\n}\n\nexport function install (name) {\n    getInterface(name).set({\n\tlock: true, pristine: true,\n\thandlers: {\n\t    '@init': opInit,\n\t    all: d => d.rr.all(d.mp.values()),\n\t    allSettled: d => d.rr.allSettled(d.mp.values()),\n\t    always: d => d.rr.always(d.mp.at(0)),\n\t    any: d => d.rr.any(d.mp.values()),\n\t    catch: d => d.rr.catch(d.mp.at(0)),\n\t    race: d => d.rr.race(d.mp.values()),\n\t    reject: d => d.rr.reject(d.mp.at(0)),\n\t    resolve: d => d.rr.resolve(d.mp.at(0)),\n\t    result: d => d.rr.result,\n\t    state: d => d.rr.state,\n\t    then: d => d.rr.then(d.mp.at(0), d.mp.at(1)),\n\t},\n    });\n}\n\n// END\n"],
  "mappings": "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",
  "names": ["getInstance", "getInterface", "setRO", "NANOS", "identity", "x", "thrower", "callable", "f", "thenable", "o", "privKey", "dualStatus", "status", "callHandlers", "list", "state", "result", "ok", "entry", "onResolve", "onReject", "next", "handler", "st", "err", "proto", "promises", "results", "remaining", "p", "idx", "res", "value", "reason", "reasons", "allRejected", "priv", "opInit", "d", "install", "name"]
}
