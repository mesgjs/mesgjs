{
  "version": 3,
  "sources": ["../../src/runtime/msjs-loop.esm.js"],
  "sourcesContent": ["/*\n * Mesgjs @loop interface\n * Author: Brian Katzung <briank@kappacs.com>\n * Copyright 2025 by Kappa Computer Solutions, LLC and Brian Katzung\n */\n\nimport { getInterface, runIfCode, setRO, throwFlow } from './runtime.esm.js';\nimport { NANOS } from './vendor.esm.js';\n\n/*\n * @codeIter(run code times=n collect=boolean)\n * Returns the collected code values or the value from the last iteration.\n */\nfunction opRun (d) {\n    const { mp, js } = d;\n    const raw = parseInt(mp.at('times', 1), 10), times = Number.isInteger(raw) ? raw : 1, collect = mp.at('collect');\n    let result = collect ? new NANOS() : undefined;\n    const save = res => { if (collect) result.push(res); else result = res; };\n    js.times = times;\n    js.active = true;\n    try { for (let i = 0; i < times; ++i) {\n\tjs.capture = false;\n\tjs.iteration = i;\n\ttry { save(runIfCode(mp.at(0))); }\n\tcatch (e) {\n\t    if (!js.capture) throw e;\n\t    if (js.hasFlowRes) {\n\t\tsave(js.flowRes);\n\t\tjs.hasFlowRes = js.flowRes = false;\n\t    }\n\t    if (e.message === 'stop') break;\n\t}\n    } } finally { js.active = false; }\n    return result;\n}\n\n/*\n * @codeIter(while pre=code main post=code collect=boolean)\n * @codeIter(while pre=code main mid=code extraCode post=code\n *   collect=boolean)\n * Returns the collected main values or the one from the last iteration.\n */\nfunction opWhile (d) {\n    const { mp, js } = d, ifc = v => (v?.msjsType === '@code') ? v : undefined;\n    // Snapshot blocks at start (in theory, they could change during execution)\n    const main = mp.at(0), xtra = ifc(mp.at(1)), pre = ifc(mp.at('pre')), mid = xtra && ifc(mp.at('mid')), post = ifc(mp.at('post'));\n    // At least one of the pre or post code blocks must be present\n    if (!pre && !mid && !post) throw new SyntaxError('(while) test {block!} required');;\n    const collect = mp.at('collect');\n    let result = collect ? new NANOS() : undefined;\n    const save = res => { if (collect) result.push(res); else result = res; };\n    const react = e => {\n\tif (!js.capture) throw e;\n\tif (js.hasFlowRes) {\n\t    save(js.flowRes);\n\t    js.hasFlowRes = js.flowRes = false;\n\t}\n\tif (e.message === 'stop') throw e;\n\tjs.capture = false;\n    };\n    js.times = undefined;\n    js.active = true;\n    try { for (let i = 0; ; ++i) {\n\tjs.capture = false;\n\tjs.iteration = i;\n\ttry {\n\t    try { if (pre && !pre('run')) break; } catch (e) { react(e); }\n\t    try { save(runIfCode(main)); } catch (e) { react(e); }\n\t    if (xtra) {\n\t\ttry { if (mid && !mid('run')) break; } catch (e) { react(e); }\n\t\ttry { xtra('run'); } catch (e) { react(e); }\n\t    }\n\t    try { if (post && !post('run')) break; } catch (e) { react(e); }\n\t} catch (e) {\n\t    js.active = false;\n\t    if (!js.capture) throw e;\n\t    if (e.message === 'stop') break;\n\t    js.active = true;\n\t}\n    } } finally { js.active = false; }\n    return result;\n}\n\n/*\n * (num) - 0-based loop number (# completed at start; first: 0)\n * (num1) - 1-based loop number (# completed at end; first: 1)\n * (rem) - # loops remaining at end (last: 0)\n * (rem1) - # loops remaining at start (last: 1)\n * (times) - total # of iterations\n * (next) - skip to the next (step in the) iteration\n * (stop) - stop without further iterations\n */\nexport function install (name) {\n    getInterface(name).set({\n\tlock: true, pristine: true,\n\thandlers: {\n\t    '@init': d => setRO(d.octx, 'js', {}),\n\t    active: d => !!d.js.active,\n\t    num: d => d.js.iteration,\n\t    num1: d => d.js.iteration + 1,\n\t    next: d => throwFlow(d, 'next', name),\n\t    rem: d => d.js.times ? (d.js.times - d.js.iteration - 1) : undefined,\n\t    rem1: d => d.js.times ? (d.js.times - d.js.iteration) : undefined,\n\t    run: opRun,\n\t    stop: d => throwFlow(d, 'stop', name),\n\t    times: d => d.js.times,\n\t    while: opWhile,\n\t},\n\tcacheHints: {\n\t    while: 'pin',\n\t},\n    });\n}\n\n// END\n"],
  "mappings": "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",
  "names": ["getInterface", "runIfCode", "setRO", "throwFlow", "NANOS", "opRun", "d", "mp", "js", "raw", "times", "collect", "result", "save", "res", "i", "e", "opWhile", "ifc", "v", "main", "xtra", "pre", "mid", "post", "react", "install", "name"]
}
