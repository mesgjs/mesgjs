{
  "version": 3,
  "sources": ["../../src/runtime/msjs-loop.esm.js"],
  "sourcesContent": ["/*\n * Mesgjs @loop interface\n * Author: Brian Katzung <briank@kappacs.com>\n * Copyright 2025 by Kappa Computer Solutions, LLC and Brian Katzung\n */\n\nimport { getInterface, runIfCode, setRO, throwFlow } from './runtime.esm.js';\nimport { NANOS } from './vendor.esm.js';\n\n/*\n * @codeIter(run code times=n collect=boolean)\n * Returns the collected code values or the value from the last iteration.\n */\nfunction opRun (d) {\n\tconst { mp, js } = d;\n\tconst raw = parseInt(mp.at('times', 1), 10), times = Number.isInteger(raw) ? raw : 1, collect = mp.at('collect');\n\tlet result = collect ? new NANOS() : undefined;\n\tconst save = res => { if (collect) result.push(res); else result = res; };\n\tjs.times = times;\n\tjs.active = true;\n\ttry { for (let i = 0; i < times; ++i) {\n\t\tjs.capture = false;\n\t\tjs.iteration = i;\n\t\ttry { save(runIfCode(mp.at(0))); }\n\t\tcatch (e) {\n\t\t\tif (!js.capture) throw e;\n\t\t\tif (js.hasFlowRes) {\n\t\t\t\tsave(js.flowRes);\n\t\t\t\tjs.hasFlowRes = js.flowRes = false;\n\t\t\t}\n\t\t\tif (e.message === 'stop') break;\n\t\t}\n\t} } finally { js.active = false; }\n\treturn result;\n}\n\n/*\n * @codeIter(while pre=code main post=code collect=boolean)\n * @codeIter(while pre=code main mid=code extraCode post=code\n *\t collect=boolean)\n * Returns the collected main values or the one from the last iteration.\n */\nfunction opWhile (d) {\n\tconst { mp, js } = d, ifc = v => (v?.msjsType === '@code') ? v : undefined;\n\t// Snapshot blocks at start (in theory, they could change during execution)\n\tconst main = mp.at(0), xtra = ifc(mp.at(1)), pre = ifc(mp.at('pre')), mid = xtra && ifc(mp.at('mid')), post = ifc(mp.at('post'));\n\t// At least one of the pre or post code blocks must be present\n\tif (!pre && !mid && !post) throw new SyntaxError('(while) test {block!} required');;\n\tconst collect = mp.at('collect');\n\tlet result = collect ? new NANOS() : undefined;\n\tconst save = res => { if (collect) result.push(res); else result = res; };\n\tconst react = e => {\n\t\tif (!js.capture) throw e;\n\t\tif (js.hasFlowRes) {\n\t\t\tsave(js.flowRes);\n\t\t\tjs.hasFlowRes = js.flowRes = false;\n\t\t}\n\t\tif (e.message === 'stop') throw e;\n\t\tjs.capture = false;\n\t};\n\tjs.times = undefined;\n\tjs.active = true;\n\ttry { for (let i = 0; ; ++i) {\n\t\tjs.capture = false;\n\t\tjs.iteration = i;\n\t\ttry {\n\t\t\ttry { if (pre && !pre('run')) break; } catch (e) { react(e); }\n\t\t\ttry { save(runIfCode(main)); } catch (e) { react(e); }\n\t\t\tif (xtra) {\n\t\t\t\ttry { if (mid && !mid('run')) break; } catch (e) { react(e); }\n\t\t\t\ttry { xtra('run'); } catch (e) { react(e); }\n\t\t\t}\n\t\t\ttry { if (post && !post('run')) break; } catch (e) { react(e); }\n\t\t} catch (e) {\n\t\t\tjs.active = false;\n\t\t\tif (!js.capture) throw e;\n\t\t\tif (e.message === 'stop') break;\n\t\t\tjs.active = true;\n\t\t}\n\t} } finally { js.active = false; }\n\treturn result;\n}\n\n/*\n * (num) - 0-based loop number (# completed at start; first: 0)\n * (num1) - 1-based loop number (# completed at end; first: 1)\n * (rem) - # loops remaining at end (last: 0)\n * (rem1) - # loops remaining at start (last: 1)\n * (times) - total # of iterations\n * (next) - skip to the next (step in the) iteration\n * (stop) - stop without further iterations\n */\nexport function install (name) {\n\tgetInterface(name).set({\n\t\tlock: true, pristine: true,\n\t\thandlers: {\n\t\t\t'@init': d => setRO(d.octx, 'js', {}),\n\t\t\tactive: d => !!d.js.active,\n\t\t\tnum: d => d.js.iteration,\n\t\t\tnum1: d => d.js.iteration + 1,\n\t\t\tnext: d => throwFlow(d, 'next', name),\n\t\t\trem: d => d.js.times ? (d.js.times - d.js.iteration - 1) : undefined,\n\t\t\trem1: d => d.js.times ? (d.js.times - d.js.iteration) : undefined,\n\t\t\trun: opRun,\n\t\t\tstop: d => throwFlow(d, 'stop', name),\n\t\t\ttimes: d => d.js.times,\n\t\t\twhile: opWhile,\n\t\t},\n\t\tcacheHints: {\n\t\t\twhile: 'pin',\n\t\t},\n\t});\n}\n\n// END\n"],
  "mappings": "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",
  "names": ["getInterface", "runIfCode", "setRO", "throwFlow", "NANOS", "opRun", "d", "mp", "js", "raw", "times", "collect", "result", "save", "res", "i", "e", "opWhile", "ifc", "v", "main", "xtra", "pre", "mid", "post", "react", "install", "name"]
}
