import{calcDigest as ae,getIntegritySHA512 as ce}from"./calc-digest.esm.js";import{NANOS as h,isIndex as Ne,parseQJSON as Ae,parseSLID as Ue}from"./vendor.esm.js";import{SieveCache as Be}from"./sieve-cache.esm.js";import{unifiedList as fe}from"./unified-list.esm.js";import"./shim.esm.js";const L=globalThis;class J extends Error{get name(){return"MsjsFlow"}}class We extends RangeError{get name(){return"MsjsFlowError"}}async function Ze(a){return ae(await ue(a,{decode:!1}),"SHA-512")}async function ue(a,{decode:d,integrity:m}={}){let y;if(typeof Deno<"u"&&!a.startsWith("https://")&&!a.startsWith("data:")){if(y=await Deno.readFile(a),!y)throw new Error(`fetchModule: File "${a}" not found`)}else y=await fetch(a).then(M=>{if(M.ok)return M.arrayBuffer();throw new Error(`fetchModule: File "${a}" not found`)});return m&&await ae(y,"SHA-512")!==m?new Error(`fetchModule: File "${a}" integrity verification failed`):d===!1?y:new TextDecoder().decode(y)}const ze=a=>new h().fromPairs(a);function X(a){if(a?.msjsType)return"M."+a.msjsType;const d=typeof a;switch(d){case"boolean":return a?"@t":"@f";case"undefined":return"@u";case"object":return a===null?"@n":"J."+(a?.constructor?.name||"Object");default:return"J."+d}}function Je(a,d,m){if(a?.has&&a.has(d))return a.at(d);if(!m)throw new ReferenceError(`Required key "${d}" not found`)}const R=a=>a?.msjsType==="@code"?a("run"):a;function et(a){for(;a?.msjsType==="@code";)a=a("run");return a}function _e(a,d,m){return a?.msjsType||(a=L.$toMsjs(a)),a(d,m)}function le(){const a=(new Error().stack||"").split(`
`);for(;a.length&&!/msjsR\$/.test(a.shift()););for(;/msjsS\$/.test(a[0]);)a.shift();const d=a[0]||"",m=d.match(/[@(](.*):(\d+):(\d+)/)||d.match(/(?:^|\s+)at\s+(.*):(\d+):(\d+)$/);if(m)return{file:m[1],line:parseInt(m[2]),column:parseInt(m[3])}}const F={writable:!1,configurable:!1},k=(a,...d)=>{if(typeof d[0]=="object"){const[m,y=!0]=d;F.enumerable=y;for(const M of Object.keys(m))F.value=m[M],Object.defineProperty(a,M,F)}else{const[m,y,M=!0]=d;[F.value,F.enumerable]=[y,M],Object.defineProperty(a,m,F)}return a};function tt(a,d,m){const{js:y,mp:M}=a;throw y.active?(y.capture=!0,M.has("result")&&(y.hasFlowRes=!0,y.flowRes=M.at("result")),new J(d)):new We(`(${d}) to inactive ${m}`)}const qe=Object.hasOwn,{debugConfig:nt,fcheck:st,fready:rt,fwait:ot,getInstance:it,getInterface:at,getModMeta:ct,initialize:ft,loadModule:ut,logInterfaces:lt,modHasCap:dt,moduleScope:Ge,setModMeta:pt,typeAccepts:ht,typeChains:gt}=(()=>{let a,d,m=0,y=0,M=2,de=0;const Y=Symbol("getCode"),P=Symbol("@init"),b=Object.create(null),v=[],j=Object.setPrototypeOf({dispatch:!1,dispatchSource:!1,dispatchTypes:!1,stack:0,stackSource:!1,stackTypes:!1},null),D=[],Z="-- Mesgjs Dispatch Stack --",ee=new Be(1024),_={st:"@core",rt:"@core",sm:_e},x=new Map,N=new h,T=new h,q=new Map,H=new Set,te=new Map;function ne(e,t,s){if(typeof e=="string"&&(e=e.split(/\s+/).filter(Boolean)),typeof e?.values=="function"){for(const n of e.values())if(!x.has(n)){const i=I("@promise");i.catch(()=>console.warn(`loadModule: Feature "${n}" rejected`)),x.set(n,i),N.push(n),t&&s&&N.set(n,new h({[s.at("deferLoad")?"defer":"preload"]:t}))}}}function pe(e){if(!D.length||!e.stack?.includes||e.stack.includes(Z))return;const t=[],s=j.stack;let n=D.length;for(let i=0;--n>=0;){const r=D[n],c=r.disp,o=typeof c.op=="symbol"?"J.Symbol":c.op;if(t.push(`${c.st} => ${c.rt}(${o}${B(j.stackTypes,c.mp)})${G(j.stackSource,r)}`),++i===s)break}n>=0&&t.push("[...]"),e.stack+=`
`+Z+`
`+t.join(`
`)}function se(e,t){return e.ucid===void 0&&k(e,"ucid",y++),(t._bc||=[])[e.ucid]||=Se(e.cd,t)}function C(e,t=!0){let s,n,i,{rr:r,rt:c,op:o,mp:f}=e,u=!1,g;if(t){const p=d;d=void 0,o===void 0&&p?.rr===r&&({sr:s,st:n,smi:i,op:o,mp:f}=p)}if(o instanceof h&&(o=o.storage),typeof o=="object"){const p=w=>qe(o,w);if(p("else")&&([u,g]=[!0,o.else]),p("mid")){const w=te.get(o.mid);w&&(i=w)}if(p("params")&&(f=o.params),p("op"))o=o.op;else if(p("0"))o=o[0];else throw new SyntaxError("Missing operation in Mesgjs list-op message")}return f instanceof h||(f=new h(f??[])),{sr:s,st:n,smi:i,rr:r,rt:c,op:o,mp:f,hasElse:u,elseExpr:g}}function he(e,t){const s=b[e];if(s&&!s.private)return I(e,t)}function ge(e){e=fe(e);for(const t of Object.keys(j)){const s=typeof j[t];switch(s){case"boolean":e?.has?.(t)&&(j[t]=!!e.at(t));break;case"number":{const n=e?.at?.(t);typeof n===s&&(j[t]=n);break}}}return new h(j)}const me=Object.setPrototypeOf({b(e){return se(e,this)},get js(){return this.octx.js},get p(){return this.octx.ps??=new h},get msjsType(){return"@dispatch"},get t(){return this._ts??=new h}},Function.prototype);function A(e,t,s){const{sr:n,st:i,smi:r,rr:c,rt:o}=e,{op:f,octx:u,handler:g,sm:p}=t,w={},l=w.bfn=Object.setPrototypeOf(Ie.bind(w,e,t,s),me);l.dop=f,l.ht=g.type,l.mop=e.op,l.mp=s,l.octx=u,l.rr=c,l.rt=o,l.sm=p,l.sr=n,l.st=i,l.smi=r;const S=j.stack,E=j.dispatch&&(de++).toString(16);try{if(j.dispatch){const W=typeof f=="symbol"?"J.Symbol":f,z=X(i);console.log(`[Mesgjs dispatch ${E}] ${z} => ${o}${g.type===o?"":"/"+g.type}(${W}${B(j.dispatchTypes,l.mp)})${G(j.dispatchSource)}`)}S&&D.push({disp:l,...j.stackSource&&le()||{}});const $=g.code(l);return E!==!1&&console.log(`[Mesgjs return ${E}]${B(j.dispatchTypes,[$])}`),$}catch($){if(l._capture&&$ instanceof J)return l._capture=!1,E!==!1&&console.log(`[Mesgjs return ${E}]${B(j.dispatchTypes,[$.info])}`),$.info;throw E!==!1&&console.warn(`[Mesgjs exception ${E}]`,$),S&&!($ instanceof J)&&pe($),$}finally{S&&D.pop()}}function we(e,t){const s=C(e),{st:n,rr:i,rt:r,mp:c,hasElse:o,elseExpr:f}=s;let u=s.op;const g=u===P||t.isInit;g&&u===P&&(s.op=u="@init");const{octx:p,handler:w=K(r,u,{isInit:g})}=t;if(!w){if(j.dispatch&&console.log(`[Mesgjs dispatch] ${n} => ${r}(${u}) [NO HANDLER]${G(j.dispatchSource)}`),o)return R(f);throw new TypeError(`No Mesgjs handler found for "${r}(${u})"`)}const l=V.bind({sr:i,st:r});return A(s,{octx:p,op:u,handler:w,sm:l,isInit:g},c)}v.push(()=>{O("@dispatch").set({pristine:!0,private:!0,lock:!0}),ie("@dispatch","ht","js","op","redis","return","rr","rt","sr","st","smi")});function U(e){const t=b[e];if(!t)return new Set;let s=t.flatChain;if(!s){s=new Set([e]);for(const n of t.chain)s.has(n)||(s=s.union(U(n)));t.flatChain=s}return s}function B(e,t){return e?[...fe(t).entries()].map(s=>Ne(s[0])?` ${X(s[1])}`:` ${s[0]}=${X(s[1])}`).join(""):""}function G(e,t){return e&&(t||(t=le()),t?.line!==void 0)?` at ${t.file}:${t.line}:${t.column}`:""}function be(e){switch(x.get(e)?.state){case"pending":return!1;case"fulfilled":return!0}}function je(...e){const t=new Set(e),s=r=>{if(!H.has("mod-"+r)){Q(r);for(const c of T.at(["modules",r,"featreq"],[]).values())t.add(c)}};for(const r of t){const c=N.at([r,"defer"]);c&&s(c)}const n=I("@promise"),i=[];n.catch(()=>{});for(const r of t)x.has(r)&&i.push(x.get(r));return n.all(i)}function ye(e,t){(q.get(e)?.at("featpro")?.includes(t)||T.at("testMode"))&&x.get(t)?.resolve()}function K(e,t,{isInit:s,next:n}={}){const i={code:()=>{},type:e,op:t};if(!s&&t==="@init")return i;const r=typeof e=="string"&&typeof t=="string"&&`${e}(${t})`,c=r&&ee.get(r);if(c)return c;const f=(()=>{let g,p;for(const w of U(e)){if(n&&w===e)continue;const l=b[w],S=l?.handlers[t];if(S)return{code:S,type:w,op:t};if(l&&!p){if(!g){const W="@defacc",z=l.handlers[W];z&&(g={code:z,type:w,op:W})}const E="@default",$=l.handlers[E];$&&(p={code:$,type:w,op:E})}}if(t==="@init")return i;if(!(p&&g&&!A(_,{op:"@defacc",octx:{},handler:g},{op:t,type:p.type})))return p})();return(!r||!f||!b[f.type].locked?!1:f.code.cache!==void 0?f.code.cache:f.op!==t||f.type!==e)&&ee.set(r,f,f.code.cache==="pin"&&f.type===e),f}function I(e,t,{sr:s,st:n,smi:i}={}){const r=b[e];if(!r)throw new TypeError(`Cannot get instance for unknown Mesgjs interface "${e}"`);if(r.instance)return r.instance;if(r.abstract)throw new TypeError(`Cannot get instance for abstract Mesgjs interface "${e}"`);const c=Object.create(null),o=function(u,g){return we({rr:o,rt:e,op:u,mp:g},{octx:c})};k(o,"msjsType",e),r.singleton&&(r.instance=o),r.locked=!0,t instanceof h||(t=new h(t??[]));try{d={sr:s,st:n,smi:i,rr:o,op:P,mp:t},o()}finally{d=void 0}return o}function O(e){if(e===":?")e=":?"+m++;else if(typeof e!="string"||!e||e.startsWith(":?")&&!b[e])return;if(e[0]==="@"&&M!==1&&!b[e])return;const t=b[e],s=!t;if(s&&(b[e]={handlers:Object.create(null),chain:new Set([]),refd:!1,abstract:!1,final:!1,locked:!1,once:!1,pristine:!0,singleton:!1}),t?.once)return;const n={name:e,isFirst:s},i=n.bfn=De.bind(n);return k(i,{ifName:e,set:r=>(oe(e,r,s),i),instance:r=>I(e,r),msjsType:"@interface"})}v.push(()=>{O("@interface").set({pristine:!0,private:!0,lock:!0}),ie("@interface","instance","name","set")});function $e(){return Object.isFrozen(T)?T:void 0}function Me(e){const t=e.at("params",e);return t instanceof h?t:new h(t??[])}function Te(e){M===2&&(M=1,v.forEach(t=>t()),e(),M=0,_.sr=_.rr=L.$c)}async function Q(e){if(H.has("mod-"+e))return;H.add("mod-"+e);const t=T.at(["modules",e]);if(t.at("url","").endsWith(".msjs"))return;const s=t.at("integrity",""),n=s==="DISABLED"?"":ce(s);if(n){if(H.has(n))return;H.add(n)}else{if(globalThis.msjsHasModMeta&&s!=="DISABLED"){const f=new Error(`loadModule: Refusing unverified module "${e}"`);return console.error(f.message),f}console.warn(`loadModule WARNING: Module "${e}" is unverified`)}const i=Re(e,t);let r,c;const o=Symbol();te.set(o,e);try{r=await ue(i,{integrity:n}),t&&(n&&q.set(n,t),q.set(o,t));const u=await import(typeof Blob=="function"&&typeof URL?.createObjectURL=="function"?URL.createObjectURL(new Blob([new TextEncoder().encode(r)],{type:"application/javascript"})):`data:application/javascript;base64,${btoa(r)}`);globalThis.msjsHasModMeta&&typeof u.loadMsjs=="function"&&u.loadMsjs(o)}catch(f){console.error(`loadModule "${e}" failed: ${f.message}`);for(const u of t?.at("featpro")?.values()||[])x.get(u)?.reject(r);return f}finally{c?.startsWith("blob:")&&URL.revokeObjectURL(c)}}function Ee(){console.log(b)}function ke(e,t){return(T?.at(["modules",e,"modcaps"])||[]).includes(t)}function xe(){const e=function(){},t=function(u){switch({op:u}=C({rr:t,op:u}),u){case"op":return"load";case"rr":case"sr":return e;case"rt":case"st":return"@module"}};let s,n;const i=f=>se(f,t),r=V.bind({sr:e,st:"@module"}),c=()=>s??=new h,o=()=>n??=new h;return k(e,"msjsType","@module"),Object.defineProperties(e,{p:{get:c,enumerable:!0},t:{get:o,enumerable:!0}}),k(t,{sr:e,st:"@module",rr:e,rt:"@module",msjsType:"@dispatch",octx:L.$u,op:"load",mp:L.$u,b:i,sm:r}),Object.defineProperties(t,{p:{get:c,enumerable:!0},t:{get:o,enumerable:!0}}),{d:t,m:e,ls:ze,na:Je}}v.push(()=>{O("@module").set({pristine:!0,private:!0,lock:!0})});function Se(e,t){const s={cd:e,od:t},n=s.bfn=Ce.bind(s);return k(n,"msjsType","@code")}function re(e,t){const s="@function",n={},i={octx:n,op:"call",handler:{code:e,type:s,op:"call"}};t!==void 0&&k(n,"ps",t);const r=i.bfn=ve.bind(i);return i.sm=V.bind({sr:r,st:s}),k(r,"msjsType",s)}v.push(()=>{O("@code").set({pristine:!0,private:!0,lock:!0,handlers:{run:!1,fn:!1}}),O("@function").set({pristine:!0,private:!0,lock:!0,handlers:{call:!1,fn:!1}}),O("@handler").set({pristine:!0,private:!0,lock:!0})});function Oe(e){const t=(s,n,i=/[\s,]+/)=>{const r=s.at(n);typeof r=="string"&&s.set(n,new h(r.split(i).filter(Boolean)))};for(const[s,n]of e?.namedEntries()||[]){const i=n.at("integrity");if(t(n,"featpro"),t(n,"featreq"),t(n,"modcaps"),i!=="DISABLED"&&!ce(i))continue;const r=n?.at("featpro",[]);ne(r,s,n)}}function Re(e,t){const s=t?.at("url");if(s)return s;const n=T.at("prefixMap");let i=["",0];for(const[o,f]of n.entries()){const u=o.length;u>i[1]&&e.startsWith(o)&&(i=[f,u])}e=i[0]+e.substring(i[1]);const r=t?.at("version"),[,c]=r&&r.match(/(\d+)/)||[];if(r&&c!==void 0){const[,o,f]=e.match(/(.*\/)?(.*)(?:(?:\.esm)?\.js)?$/);e=`${o}${f}/${c}/${f}@${r}`}return e.endsWith(".js")||(e+=".esm.js"),e}function Ce(e,t){const s=C({rr:this.bfn,op:e,mp:t}),{op:n,mp:i,hasElse:r,elseExpr:c}=s;if(n==="run")return this.cd(this.od);switch(n){case P:case"@init":return;case Y:a={code:this.cd};return;case"fn":return re(this.cd,i)}if(r)return R(c);throw new TypeError(`No Mesgjs handler found for "@code(${n})"`)}function Ie(e,t,s){const{op:n,mp:i,elseExpr:r}=C({rr:this.bfn}),{octx:c,handler:o,isInit:f,sm:u}=t;switch(n){case"dop":return t.op;case"ht":return o.type;case"js":return c.js;case"log":console.dir(this.bfn,{depth:null});return;case"mop":return e.op;case"redis":{const g=i.has("else")?i.at("else"):r,p=i.at("type"),w=p&&p!=="@next"?p:o.type;if(!U(o.type).has(w))return R(g);const l=i.has("op")?i.at("op"):o.op,S=Me(i),E=w===o.type&&l===o.op||p==="@next",$=K(w,l,{isInit:f,next:E});return!$||!i.has("op")&&$.op!==l?R(g):A(e,{octx:c,op:l,isInit:f,handler:$,sm:u},S)}case"return":throw this.bfn._capture=!0,new J("return",i.at(0));case"rr":return e.rr;case"rt":return e.rt;case"sr":return e.sr;case"st":return e.st;case"smi":return e.smi;case void 0:throw new TypeError(`"${o.type}(${t.op})": @dispatch messages must be attributed`)}return R(r)}function Fe(...e){return this.bfn("call",new h([...e]))}function ve(e,t){const s=C({rr:this.bfn,op:e,mp:t}),{op:n,mp:i,hasElse:r,elseExpr:c}=s;if(n==="call")return A(s,this,i);switch(n){case"fn":return re(this.handler.code,i);case"jsfn":return this.jsFn||=Fe.bind(this)}if(r)return R(c);throw new TypeError(`No Mesgjs handler found for "@function(${n})"`)}function De(e,t){const s=this.name,{op:n,mp:i,sr:r,st:c,smi:o,hasElse:f,elseExpr:u}=C({rr:this.bfn,op:e,mp:t});switch(n){case"instance":return I(s,i,{sr:r,st:c,smi:o});case"name":return s;case"set":return oe(s,i,this.isFirst),this.bfn}if(f)return R(u);throw new TypeError(`No Mesgjs handler found for "@interface(${n})"`)}function V(e,t,s){e?.msjsType||(e=L.$toMsjs(e)),d={sr:this.sr,st:this.st,rr:e,op:t,mp:s};let n;try{n=e()}finally{d=void 0}return n}function oe(e,t,s){if(e[0]==="@"&&M!==1)throw new TypeError(`Cannot configure Mesgjs interface "${e}" after runtime initialization`);const n=b[e];if(t instanceof h&&(t=t.storage),t.once&&!s||t.pristine&&!n.pristine)throw new TypeError(`Mesgjs interface "${e}" is not pristine`);if(n.pristine=!1,n.locked)throw new TypeError(`Cannot change locked Mesgjs interface "${e}"`);if(t.chain){if(n.chain.size)throw new TypeError(`Cannot change chain for Mesgjs interface "${e}"`);if(n.refd)throw new TypeError(`Cannot set chain for active Mesgjs interface "${e}"`);const c=new Set(Object.values(t.chain.storage||t.chain||[]));for(const o of c){if(!b[o])throw new ReferenceError(`Mesgjs interface "${e}" references unknown interface "${o}"`);if(b[o].final)throw new TypeError(`Mesgjs interface "${e}" tries to extend final interface "${o}"`);b[o].refd=!0}n.chain=c}const i=t.handlers||{};for(const[c,o]of i instanceof h?i.entries():Object.entries(i))typeof o=="function"?o.msjsType==="@code"?(a=void 0,o(Y),a?.code&&k(n.handlers[c]=a.code,"msjsType","@handler")):n.handlers[c]=o:o===!1&&(n.handlers[c]=!1);a=void 0;const r=t.cacheHints||{};for(const[c,o]of r instanceof h?r.entries():Object.entries(r))switch(o){case!0:case!1:case"pin":n.handlers[c]&&(n.handlers[c].cache=o);break}t.init&&(n.init=t.init),t.abstract&&(n.abstract=!0),t.final&&(n.final=!0),t.lock&&(n.locked=!0),t.once&&(n.once=!0),t.private&&(n.private=!0),t.singleton&&(n.singleton=!0)}function He(e){if(globalThis.msjsHasModMeta)return;if(e instanceof h)T.push(Ue(e.toSLID()));else if(typeof e=="object")T.push(Ae(JSON.stringify(e)));else return;k(globalThis,{msjsHasModMeta:!0,msjsNoSelfLoad:!0}),Oe(T.at("modules")),T.at("testMode")&&ne(T.at("features",[])),T.set("allFeatures",N),T.deepFreeze();const t=I("@promise"),s=[];x.set("@loaded",t);for(const[n,i]of T.at("modules")?.entries()||[])i.at("deferLoad")||s.push(Q(n));t.allSettled(s)}function ie(e,...t){const s=b[e]?.handlers;s&&t.forEach(n=>s[n]=!1)}function Le(e,t){if(t===void 0){const n=b[e];return n&&!n.private?[...Object.keys(n.handlers)]:void 0}const s=K(e,t);if(s)return[s.type,s.op==="@default"?"default":"specific"]}function Pe(e,t){if(!b[e]?.private)return t===void 0?b[e]?Array.from(b[e].chain):void 0:U(e).has(t)}return{debugConfig:ge,fcheck:be,fready:ye,fwait:je,getInstance:he,getInterface:O,getModMeta:$e,initialize:Te,logInterfaces:Ee,loadModule:Q,modHasCap:ke,moduleScope:xe,setModMeta:He,typeAccepts:Le,typeChains:Pe}})();k(globalThis,{$f:!1,$gss:new h,$n:null,$t:!0,$u:void 0,$modScope:Ge});export{J as MsjsFlow,We as MsjsFlowError,Ze as calcIntegrity,nt as debugConfig,st as fcheck,ue as fetchModule,rt as fready,ot as fwait,it as getInstance,at as getInterface,ct as getModMeta,ft as initialize,ze as listFromPairs,ut as loadModule,lt as logInterfaces,X as loggedType,dt as modHasCap,Ge as moduleScope,Je as namespaceAt,R as runIfCode,et as runWhileCode,_e as sendAnonMessage,le as senderFLC,pt as setModMeta,k as setRO,tt as throwFlow,ht as typeAccepts,gt as typeChains};
