import{calcDigest as te,getIntegritySHA512 as ne}from"./calc-digest.esm.js";import{NANOS as h,isIndex as ve,parseQJSON as Fe,parseSLID as Pe}from"./vendor.esm.js";import{SieveCache as Je}from"./sieve-cache.esm.js";import{unifiedList as se}from"./unified-list.esm.js";import"./shim.esm.js";const J=globalThis,Ke=Symbol.for("msjsInstance");class L extends Error{constructor(f,l){super(f),l!==void 0&&(this.info=l)}get name(){return"MSJSFlow"}}class De extends RangeError{constructor(...f){super(...f),this.name="MSJSFlowError"}}async function qe(a){return te(await re(a,{decode:!1}),"SHA-512")}async function re(a,f,{decode:l,integrity:y}={}){const w=a?`${a}/${f}`:f;let S;return a&&(S=await fetch(w).arrayBuffer()),typeof Deno<"u"&&(S=await Deno.readFile(f)),S?y&&await te(S,"SHA-512")!==y?new Error(`fetchModule: File "${w}" integrity verification failed`):l===!1?S:new TextDecoder().decode(S):new Error(`fetchModule: File "${f}" not found`)}const He=a=>new h().fromPairs(a);function oe(a){if(a?.msjsType)return"S."+a.msjsType;const f=typeof a;switch(f){case"boolean":return a?"@t":"@f";case"undefined":return"@u";case"object":return a===null?"@n":"J."+(a?.constructor?.name||"Object");default:return"J."+f}}function Ne(a,f,l){if(a?.has&&a.has(f))return a.at(f);if(!l)throw new ReferenceError(`Required key "${f}" not found`)}const O=a=>a?.msjsType==="@code"?a("run"):a;function Ae(a,f,l){return a?.msjsType||(a=J.$toMSJS(a)),a(f,l)}function ie(){const a=(new Error().stack||"").split(`
`);for(;a.length&&!/msjsR\$/.test(a.shift()););for(;/msjsS\$/.test(a[0]);)a.shift();const f=a[0]||"",l=f.match(/[@(](.*):(\d+):(\d+)/)||f.match(/(?:^|\s+)at\s+(.*):(\d+):(\d+)$/);if(l)return{file:l[1],line:parseInt(l[2]),column:parseInt(l[3])}}const v={writable:!1,configurable:!1},$=(a,...f)=>{if(typeof f[0]=="object"){const[l,y=!0]=f;v.enumerable=y;for(const w of Object.keys(l))v.value=l[w],Object.defineProperty(a,w,v)}else{const[l,y,w=!0]=f;[v.value,v.enumerable]=[y,w],Object.defineProperty(a,l,v)}return a};function Qe(a,f,l){const{js:y,mp:w}=a;throw y.active?(y.capture=!0,w.has("result")&&(y.hasFlowRes=!0,y.flowRes=w.at("result")),new L(f)):new De(`(${f}) to inactive ${l}`)}const Le=Object.hasOwn,{debugConfig:Ve,fcheck:Xe,fready:Ye,fwait:Ze,getInstance:et,getInterface:tt,initialize:nt,loadModule:st,logInterfaces:rt,moduleScope:Ue,setModMeta:ot,typeAccepts:it,typeChains:ct}=(()=>{let a,f,l=0,y=0,w=2,S=0;const K=Symbol("getCode"),U=Symbol("@init"),g=Object.create(null),F=[],b=Object.setPrototypeOf({dispatch:!1,dispatchSource:!1,dispatchTypes:!1,stack:0,stackSource:!1,stackTypes:!1},null),P=[],q="-- Mesgjs Dispatch Stack --",Q=new Je(1024),_={st:"@core",rt:"@core",sm:Ae},D=new Set,T=new Map,C=new h,B=new Map;function ce(e){for(const t of e.keys()||[]){const n=e.at(t);if(ne(n?.at("integrity"))){for(const s of n?.at("featpro")?.values()||[])if(!T.has(s)){const o=I("@promise");o.catch(()=>console.log(`loadModule: Feature "${s}" rejected`)),T.set(s,o)}}}}function ae(e){if(!P.length||!e.stack?.includes||e.stack.includes(q))return;const t=[],n=b.stack;let s=P.length;for(let o=0;--s>=0;){const i=P[s],r=i.disp,c=typeof r.op=="symbol"?"J.Symbol":r.op;if(t.push(`${r.st} => ${r.rt}(${c}${A(b.stackTypes,r.mp)})${z(b.stackSource,i)}`),++o===n)break}s>=0&&t.push("[...]"),e.stack+=`
`+q+`
`+t.join(`
`)}function V(e,t){return e.ucid===void 0&&$(e,"ucid",y++),(t._bc||=[])[e.ucid]||=$e(e.cd,t)}function R(e,t=!0){let n,s,{rr:o,rt:i,op:r,mp:c}=e,p=!1,d;if(t){const m=f;f=void 0,r===void 0&&m?.rr===o&&({sr:n,st:s,op:r,mp:c}=m)}if(r instanceof h&&(r=r.storage),typeof r=="object"){const m=j=>Le(r,j);if(m("else")&&([p,d]=[!0,r.else]),m("params")&&(c=r.params),m("op"))r=r.op;else if(m("0"))r=r[0];else throw new SyntaxError("Missing operation in Mesgjs list-op message")}return c instanceof h||(c=new h(c??[])),{sr:n,st:s,rr:o,rt:i,op:r,mp:c,hasElse:p,elseExpr:d}}function fe(e,t){const n=g[e];if(n&&!n.private)return I(e,t)}function ue(e){e=se(e);for(const t of Object.keys(b)){const n=typeof b[t];switch(n){case"boolean":e.has(t)&&(b[t]=!!e.at(t));break;case"number":{const s=e.at(t);typeof s===n&&(b[t]=s);break}}}return new h(b)}const le=Object.setPrototypeOf({b(e){return V(e,this)},get js(){return this.octx.js},get p(){return this.octx.ps??=new h},get msjsType(){return"@dispatch"},get t(){return this._ts??=new h}},Object.getPrototypeOf(Function));function H(e,t,n){const{sr:s,st:o,rr:i,rt:r}=e,{op:c,octx:p,handler:d,sm:m}=t,j={},u=j.bfn=Object.setPrototypeOf(Te.bind(j,e,t,n),le);u.dop=c,u.ht=d.type,u.mop=e.op,u.mp=n,u.octx=p,u.rr=i,u.rt=r,u.sm=m,u.sr=s,u.st=o;const x=b.stack,E=b.dispatch&&(S++).toString(16);try{if(b.dispatch){const Ie=typeof u.op=="symbol"?"J.Symbol":u.op;console.log(`[Mesgjs dispatch ${E}] ${o} => ${r}${d.type===r?"":"/"+d.type}(${Ie}${A(b.dispatchTypes,u.mp)})${z(b.dispatchSource)}`)}x&&P.push({disp:u,...b.stackSource&&ie()||{}});const M=d.code(u);return E!==!1&&console.log(`[Mesgjs return ${E}]${A(b.dispatchTypes,[M])}`),M}catch(M){if(u._capture&&M instanceof L)return u._capture=!1,E!==!1&&console.log(`[Mesgjs return ${E}]${A(b.dispatchTypes,[M.info])}`),M.info;throw E!==!1&&console.log(`[Mesgjs exception ${E}]`,M),x&&!(M instanceof L)&&ae(M),M}finally{x&&P.pop()}}function de(e,t){const n=R(e),{st:s,rr:o,rt:i,op:r,mp:c,hasElse:p,elseExpr:d}=n,{octx:m,handler:j=W(i,r)}=t;if(!j){if(b.dispatch&&console.log(`[Mesgjs dispatch] ${s} => ${i}(${r}) [NO HANDLER]${z(b.dispatchSource)}`),p)return O(d);throw new TypeError(`No Mesgjs handler found for "${i}(${r})"`)}const u=G.bind({sr:o,st:i});return H(n,{octx:m,op:r,handler:j,sm:u},c)}F.push(()=>{k("@dispatch").set({pristine:!0,private:!0,lock:!0}),ee("@dispatch","ht","js","op","redis","return","rr","rt","sr","st")});function N(e){const t=g[e];if(!t)return new Set;let n=t.flatChain;if(!n){n=new Set([e]);for(const s of t.chain)n.has(s)||(n=n.union(N(s)));t.flatChain=n}return n}function A(e,t){return e?[...se(t).entries()].map(n=>ve(n[0])?` ${oe(n[1])}`:` ${n[0]}=${oe(n[1])}`).join(""):""}function z(e,t){return e&&(t||(t=ie()),t?.line!==void 0)?` at ${t.file}:${t.line}:${t.column}`:""}function pe(e){switch(T.get(e)?.state){case"pending":return!1;case"resolved":return!0}}function he(...e){const t=I("@promise"),n=[];t.catch(()=>{});for(const s of e)T.has(s)&&n.push(T.get(s));return t.all(n)}function ge(e,t){const n=B.get(e);n&&n.featpro?.includes(t)&&T.get(t)?.resolve()}function W(e,t,n=!1){const s={code:()=>{},type:e,op:t};if(t==="@init")return s;t===U&&(t="@init");const o=typeof e=="string"&&typeof t=="string"&&`${e}(${t})`,i=o&&Q.get(o);if(i)return i;const r=be(e,t,n,s);return(!o||!r||!g[r.type].locked?!1:r.code.cache!==void 0?r.code.cache:r.op!==t||r.type!==e)&&Q.set(o,r,r.code.cache==="pin"&&r.type===e),r}function be(e,t,n,s){let o,i;for(const r of N(e)){if(n&&r===e)continue;const c=g[r],p=c?.handlers[t];if(p)return{code:p,type:r,op:t};if(c&&!i){if(!o){const j="@defacc",u=c.handlers[j];u&&(o={code:u,type:r,op:j})}const d="@default",m=c.handlers[d];m&&(i={code:m,type:r,op:d})}}if(t==="@init")return s;if(!(i&&o&&!H(_,{op:"@defacc",octx:{},handler:o},{op:t,type:i.type})))return i}function I(e,t){const n=g[e];if(!n)throw new TypeError(`Cannot get instance for unknown Mesgjs interface "${e}"`);if(n.instance)return n.instance;const s=Object.create(null),o=function(r,c){return de({rr:o,rt:e,op:r,mp:c},{octx:s})};return $(o,"msjsType",e),n.singleton&&(n.instance=o),n.refd=!0,t instanceof h||(t=new h(t??[])),o(U,t),o}function k(e){if(e==="?")e="?"+l++;else if(typeof e!="string"||!e||e[0]==="?"&&!g[e]||e[0]==="@"&&w!==1)return;const t=g[e],n=!t;if(n&&(g[e]={handlers:Object.create(null),chain:new Set([]),refd:!1,abstract:!1,final:!1,locked:!1,once:!1,pristine:!0,singleton:!1}),t?.once)return;const s={name:e,isFirst:n},o=s.bfn=Ee.bind(s);return $(o,{ifName:e,set:i=>Z(e,i,n),instance:i=>I(e,i),msjsType:"@interface"})}F.push(()=>{k("@interface").set({pristine:!0,private:!0,lock:!0}),ee("@interface","instance","name","set")});function me(e){const t=e.at("params",e);return t instanceof h?t:new h(t??[])}function we(){w===2&&(w=1,F.forEach(e=>e()),globalThis.installMSJSCoreExtensions(),w=0,_.sr=_.rr=J.$c)}async function X(e){if(D.has("src-"+e))return;D.add("src-"+e);const t=C?.at("modules")?.at(e),n=ne(t?.at("integrity"));if(n){if(D.has(n))return;D.add(n)}else{if(globalThis.msjsModMeta)throw new Error(`loadModule: Refusing unverified module "${e}"`);console.log(`loadModule WARNING: Module "${e}" is unverified`)}e=Me(e,t);const s=await re(e,{integrity:n});if(s instanceof Error){for(const r of t?.at("featpro")?.values()||[])T.get(r)?.reject(s);throw s}if(t){const r=Symbol();t.set("mid",r),B.set(n,t),B.set(r,t)}const o=typeof Blob=="function"&&typeof o?.createObjectURL=="function"?o.createObjectURL(new Blob([new TextEncoder().encode(s)],{type:"application/javascript"})):`data:application/javascript;base64,${btoa(s)}`,i=await import(o);o.startsWith("blob:")&&o.revokeObjectURL(o),globalThis.msjsModMeta&&i.loadMSJS&&i.loadMSJS(t?.mid)}function je(){console.log(g)}function ye(){const e=function(){},t=function(d){switch({op:d}=R({rr:t,op:d}),d){case"op":return"load";case"rr":case"sr":return e;case"rt":case"st":return"@module"}};let n,s;const o=p=>V(p,t),i=G.bind({sr:e,st:"@module"}),r=()=>n??=new h,c=()=>s??=new h;return $(e,"msjsType","@module"),Object.defineProperties(e,{p:{get:r,enumerable:!0},t:{get:c,enumerable:!0}}),$(t,{sr:e,st:"@module",rr:e,rt:"@module",msjsType:"@dispatch",octx:J.$u,op:"load",mp:J.$u,b:o,sm:i}),Object.defineProperties(t,{p:{get:r,enumerable:!0},t:{get:c,enumerable:!0}}),{d:t,m:e,ls:He,na:Ne}}F.push(()=>{k("@module").set({pristine:!0,private:!0,lock:!0})});function $e(e,t){const n={cd:e,od:t},s=n.bfn=Se.bind(n);return $(s,"msjsType","@code")}function Y(e,t){const n="@function",s={},o={octx:s,op:"call",handler:{code:e,type:n,op:"call"}};t!==void 0&&$(s,"ps",t);const i=o.bfn=xe.bind(o);return o.sm=G.bind({sr:i,st:n}),$(i,"msjsType",n)}F.push(()=>{k("@code").set({pristine:!0,private:!0,lock:!0,handlers:{run:!1,fn:!1}}),k("@function").set({pristine:!0,private:!0,lock:!0,handlers:{call:!1,fn:!1}}),k("@handler").set({pristine:!0,private:!0,lock:!0})});function Me(e,t){const n=t?.at("url");if(n)return n;const s=C.at("prefixMap");let o=["",0];for(const[c,p]of s.entries()){const d=c.length;d>o[1]&&e.startsWith(c)&&(o=[p,d])}e=o[0]+e.substring(o[1]);const i=t?.at("version"),[,r]=i&&i.match(/(\d+)/)||[];if(i&&r!==void 0){const[,c,p]=e.match(/(.*\/)?(.*)(?:(?:\.esm)?\.js)?$/);e=`${c}${p}/${r}/${p}@${i}`}return e.endsWith(".js")||(e+=".esm.js"),e}function Se(e,t){const n=R({rr:this.bfn,op:e,mp:t}),{op:s,mp:o,hasElse:i,elseExpr:r}=n;if(s==="run")return this.cd(this.od);switch(s){case U:return;case K:a={code:this.cd};return;case"fn":return Y(this.cd,o)}if(i)return O(r);throw new TypeError(`No Mesgjs handler found for "@code(${s})"`)}function Te(e,t,n){const{op:s,mp:o,elseExpr:i}=R({rr:this.bfn}),{octx:r,handler:c,sm:p}=t;switch(s){case"dop":return t.op;case"ht":return c.type;case"js":return r.js;case"log":console.dir(this.bfn,{depth:null});return;case"mop":return e.op;case"redis":{const d=o.has("else")?o.at("else"):i,m=o.at("type")||c.type;if(!N(c.type).has(m))return O(d);const j=o.has("op")?o.at("op"):c.op,u=me(o),x=W(m,j,m===c.type&&j===c.op);return!x||!o.has("op")&&x.op!==j?O(d):H(e,{octx:r,op:j,handler:x,sm:p},u)}case"return":throw this.bfn._capture=!0,new L("return",o.at(0));case"rr":return e.rr;case"rt":return e.rt;case"sr":return e.sr;case"st":return e.st}return O(i)}function ke(...e){return this.bfn("call",new h([...e]))}function xe(e,t){const n=R({rr:this.bfn,op:e,mp:t}),{op:s,mp:o,hasElse:i,elseExpr:r}=n;if(s==="call")return H(n,this,o);switch(s){case"fn":return Y(this.handler.code,o);case"jsfn":return this.jsFn||=ke.bind(this)}if(i)return O(r);throw new TypeError(`No Mesgjs handler found for "@function(${s})"`)}function Ee(e,t){const n=this.name,{op:s,mp:o,hasElse:i,elseExpr:r}=R({rr:this.bfn,op:e,mp:t});switch(s){case"instance":return I(n,o);case"name":return n;case"set":return Z(n,o,this.isFirst)}if(i)return O(r);throw new TypeError(`No Mesgjs handler found for "@interface(${s})"`)}function G(e,t,n){e?.msjsType||(e=J.$toMSJS(e)),f={sr:this.sr,st:this.st,rr:e,op:t,mp:n};let s;try{s=e()}finally{f=void 0}return s}function Z(e,t,n){if(e[0]==="@"&&w!==1)throw new TypeError(`Cannot configure Mesgjs interface "${e}" after runtime initialization`);const s=g[e];if(t instanceof h&&(t=t.storage),t.once&&!n||t.pristine&&!s.pristine)throw new TypeError(`Mesgjs interface "${e}" is not pristine`);if(s.pristine=!1,s.locked)throw new TypeError(`Cannot change locked Mesgjs interface "${e}"`);if(t.chain){if(s.chain.size)throw new TypeError(`Cannot change chain for Mesgjs interface "${e}"`);if(s.refd)throw new TypeError(`Cannot set chain for active Mesgjs interface "${e}"`);const r=new Set(Object.values(t.chain.storage||t.chain||[]));for(const c of r){if(!g[c])throw new ReferenceError(`Mesgjs interface "${e}" references unknown interface "${c}"`);if(g[c].final)throw new TypeError(`Mesgjs interface "${e}" tries to extend final interface "${c}"`);g[c].refd=!0}s.chain=r}const o=t.handlers||{};for(const[r,c]of o instanceof h?o.entries():Object.entries(o))typeof c=="function"?c.msjsType==="@code"?(a=void 0,c(K),a?.code&&$(s.handlers[r]=a.code,"msjsType","@handler")):s.handlers[r]=c:c===!1&&(s.handlers[r]=!1);a=void 0;const i=t.cacheHints||{};for(const[r,c]of i instanceof h?i.entries():Object.entries(i))switch(c){case!0:case!1:case"pin":s.handlers[r]&&(s.handlers[r].cache=c);break}t.init&&(s.init=t.init),t.abstract&&(s.abstract=!0),t.final&&(s.final=!0),t.lock&&(s.locked=!0),t.once&&(s.once=!0),t.singleton&&(s.singleton=!0)}function Oe(e){if(globalThis.msjsModMeta)return;$(globalThis,"msjsModMeta",!0),e instanceof h?C.push(Pe(e.toSLID())):C.push(Fe(JSON.stringify(e))),ce(C.at("modules"));const t=I("@promise"),n=[];T.set("@loaded",t);for(const s of C.at("modules").entries())s[1].at("defLoad")||n.push(X(s[0]));t.allSettled(...n)}function ee(e,...t){const n=g[e]?.handlers;n&&t.forEach(s=>n[s]=!1)}function Ce(e,t){if(t===void 0){const s=g[e];return s&&!s.private?[...Object.keys(s.handlers)]:void 0}const n=W(e,t);if(n)return[n.type,n.op==="@default"?"default":"specific"]}function Re(e,t){if(!g[e]?.private)return t===void 0?g[e]?Array.from(g[e].chain):void 0:N(e).has(t)}return{debugConfig:ue,fcheck:pe,fready:ge,fwait:he,getInstance:fe,getInterface:k,initialize:we,logInterfaces:je,loadModule:X,moduleScope:ye,setModMeta:Oe,typeAccepts:Ce,typeChains:Re}})();$(globalThis,{$f:!1,$gss:new h,$n:null,$t:!0,$u:void 0,$modScope:Ue});export{L as MSJSFlow,De as MSJSFlowError,qe as calcIntegrity,Ve as debugConfig,Xe as fcheck,re as fetchModule,Ye as fready,Ze as fwait,et as getInstance,tt as getInterface,nt as initialize,He as listFromPairs,st as loadModule,rt as logInterfaces,oe as loggedType,Ue as moduleScope,Ke as msjsInstance,Ne as namespaceAt,O as runIfCode,Ae as sendAnonMessage,ie as senderFLC,ot as setModMeta,$ as setRO,Qe as throwFlow,it as typeAccepts,ct as typeChains};
