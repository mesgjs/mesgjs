import{calcDigest as re,getIntegritySHA512 as oe}from"./calc-digest.esm.js";import{NANOS as d,isIndex as Ne,parseQJSON as Ae,parseSLID as Ue}from"./vendor.esm.js";import{SieveCache as Be}from"./sieve-cache.esm.js";import{unifiedList as ie}from"./unified-list.esm.js";import"./shim.esm.js";const D=globalThis;class A extends Error{get name(){return"MsjsFlow"}}class We extends RangeError{get name(){return"MsjsFlowError"}}async function Ze(a){return re(await ce(a,{decode:!1}),"SHA-512")}async function ce(a,{decode:u,integrity:h}={}){let j;if(typeof Deno<"u"&&!a.startsWith("https://")&&!a.startsWith("data:")){if(j=await Deno.readFile(a),!j)throw new Error(`fetchModule: File "${a}" not found`)}else j=await fetch(a).then(w=>{if(w.ok)return w.arrayBuffer();throw new Error(`fetchModule: File "${a}" not found`)});return h&&await re(j,"SHA-512")!==h?new Error(`fetchModule: File "${a}" integrity verification failed`):u===!1?j:new TextDecoder().decode(j)}const _e=a=>new d().fromPairs(a);function G(a){if(a?.msjsType)return"M."+a.msjsType;const u=typeof a;switch(u){case"boolean":return a?"@t":"@f";case"undefined":return"@u";case"object":return a===null?"@n":"J."+(a?.constructor?.name||"Object");default:return"J."+u}}function ze(a,u,h){if(a?.has&&a.has(u))return a.at(u);if(!h)throw new ReferenceError(`Required key "${u}" not found`)}const O=a=>a?.msjsType==="@code"?a("run"):a;function et(a){for(;a?.msjsType==="@code";)a=a("run");return a}function Je(a,u,h){return a?.msjsType||(a=D.$toMsjs(a)),a(u,h)}function ae(){const a=(new Error().stack||"").split(`
`);for(;a.length&&!/msjsR\$/.test(a.shift()););for(;/msjsS\$/.test(a[0]);)a.shift();const u=a[0]||"",h=u.match(/[@(](.*):(\d+):(\d+)/)||u.match(/(?:^|\s+)at\s+(.*):(\d+):(\d+)$/);if(h)return{file:h[1],line:parseInt(h[2]),column:parseInt(h[3])}}const F={writable:!1,configurable:!1},T=(a,...u)=>{if(typeof u[0]=="object"){const[h,j=!0]=u;F.enumerable=j;for(const w of Object.keys(h))F.value=h[w],Object.defineProperty(a,w,F)}else{const[h,j,w=!0]=u;[F.value,F.enumerable]=[j,w],Object.defineProperty(a,h,F)}return a};function tt(a,u,h){const{js:j,mp:w}=a;throw j.active?(j.capture=!0,w.has("result")&&(j.hasFlowRes=!0,j.flowRes=w.at("result")),new A(u)):new We(`(${u}) to inactive ${h}`)}const qe=Object.hasOwn,{debugConfig:nt,fcheck:st,fready:rt,fwait:ot,getInstance:it,getInterface:ct,getModMeta:at,initialize:ft,loadModule:ut,logInterfaces:lt,modHasCap:dt,moduleScope:Ge,setModMeta:pt,typeAccepts:ht,typeChains:gt}=(()=>{let a,u,h=0,j=0,w=2,fe=0;const K=Symbol("getCode"),U=Symbol("@init"),m=Object.create(null),I=[],b=Object.setPrototypeOf({dispatch:!1,dispatchSource:!1,dispatchTypes:!1,stack:0,stackSource:!1,stackTypes:!1},null),v=[],Q="-- Mesgjs Dispatch Stack --",V=new Be(1024),B={st:"@core",rt:"@core",sm:Je},E=new Map,$=new d,W=new Map,H=new Set,X=new Map;function Y(e){if(typeof e=="string"&&(e=e.split(/\s+/).filter(Boolean)),typeof e?.values=="function"){for(const t of e.values())if(!E.has(t)){const s=C("@promise");s.catch(()=>console.warn(`loadModule: Feature "${t}" rejected`)),E.set(t,s)}}}function ue(e){if(!v.length||!e.stack?.includes||e.stack.includes(Q))return;const t=[],s=b.stack;let n=v.length;for(let r=0;--n>=0;){const c=v[n],i=c.disp,o=typeof i.op=="symbol"?"J.Symbol":i.op;if(t.push(`${i.st} => ${i.rt}(${o}${N(b.stackTypes,i.mp)})${_(b.stackSource,c)}`),++r===s)break}n>=0&&t.push("[...]"),e.stack+=`
`+Q+`
`+t.join(`
`)}function Z(e,t){return e.ucid===void 0&&T(e,"ucid",j++),(t._bc||=[])[e.ucid]||=Ee(e.cd,t)}function R(e,t=!0){let s,n,r,{rr:c,rt:i,op:o,mp:f}=e,l=!1,y;if(t){const p=u;u=void 0,o===void 0&&p?.rr===c&&({sr:s,st:n,op:o,mp:f}=p)}if(o instanceof d&&(o=o.storage),typeof o=="object"){const p=M=>qe(o,M);if(p("else")&&([l,y]=[!0,o.else]),p("mid")){const M=X.get(o.mid);M&&(r=M)}if(p("params")&&(f=o.params),p("op"))o=o.op;else if(p("0"))o=o[0];else throw new SyntaxError("Missing operation in Mesgjs list-op message")}return f instanceof d||(f=new d(f??[])),{sr:s,st:n,smi:r,rr:c,rt:i,op:o,mp:f,hasElse:l,elseExpr:y}}function le(e,t){const s=m[e];if(s&&!s.private)return C(e,t)}function de(e){e=ie(e);for(const t of Object.keys(b)){const s=typeof b[t];switch(s){case"boolean":e?.has?.(t)&&(b[t]=!!e.at(t));break;case"number":{const n=e?.at?.(t);typeof n===s&&(b[t]=n);break}}}return new d(b)}const pe=Object.setPrototypeOf({b(e){return Z(e,this)},get js(){return this.octx.js},get p(){return this.octx.ps??=new d},get msjsType(){return"@dispatch"},get t(){return this._ts??=new d}},Object.getPrototypeOf(Function));function P(e,t,s){const{sr:n,st:r,smi:c,rr:i,rt:o}=e,{op:f,octx:l,handler:y,sm:p}=t,M={},g=M.bfn=Object.setPrototypeOf(Re.bind(M,e,t,s),pe);g.dop=f,g.ht=y.type,g.mop=e.op,g.mp=s,g.octx=l,g.rr=i,g.rt=o,g.sm=p,g.sr=n,g.st=r,g.smi=c;const q=b.stack,S=b.dispatch&&(fe++).toString(16);try{if(b.dispatch){const Pe=typeof f=="symbol"?"J.Symbol":f,Le=G(r);console.log(`[Mesgjs dispatch ${S}] ${Le} => ${o}${y.type===o?"":"/"+y.type}(${Pe}${N(b.dispatchTypes,g.mp)})${_(b.dispatchSource)}`)}q&&v.push({disp:g,...b.stackSource&&ae()||{}});const k=y.code(g);return S!==!1&&console.log(`[Mesgjs return ${S}]${N(b.dispatchTypes,[k])}`),k}catch(k){if(g._capture&&k instanceof A)return g._capture=!1,S!==!1&&console.log(`[Mesgjs return ${S}]${N(b.dispatchTypes,[k.info])}`),k.info;throw S!==!1&&console.warn(`[Mesgjs exception ${S}]`,k),q&&!(k instanceof A)&&ue(k),k}finally{q&&v.pop()}}function he(e,t){const s=R(e),{st:n,rr:r,rt:c,op:i,mp:o,hasElse:f,elseExpr:l}=s,{octx:y,handler:p=z(c,i)}=t;if(!p){if(b.dispatch&&console.log(`[Mesgjs dispatch] ${n} => ${c}(${i}) [NO HANDLER]${_(b.dispatchSource)}`),f)return O(l);throw new TypeError(`No Mesgjs handler found for "${c}(${i})"`)}const M=J.bind({sr:r,st:c});return P(s,{octx:y,op:i,handler:p,sm:M},o)}I.push(()=>{x("@dispatch").set({pristine:!0,private:!0,lock:!0}),se("@dispatch","ht","js","op","redis","return","rr","rt","sr","st","smi")});function L(e){const t=m[e];if(!t)return new Set;let s=t.flatChain;if(!s){s=new Set([e]);for(const n of t.chain)s.has(n)||(s=s.union(L(n)));t.flatChain=s}return s}function N(e,t){return e?[...ie(t).entries()].map(s=>Ne(s[0])?` ${G(s[1])}`:` ${s[0]}=${G(s[1])}`).join(""):""}function _(e,t){return e&&(t||(t=ae()),t?.line!==void 0)?` at ${t.file}:${t.line}:${t.column}`:""}function ge(e){switch(E.get(e)?.state){case"pending":return!1;case"fulfilled":return!0}}function me(...e){const t=C("@promise"),s=[];t.catch(()=>{});for(const n of e)E.has(n)&&s.push(E.get(n));return t.all(s)}function be(e,t){(W.get(e)?.at("featpro")?.includes(t)||$.at("testMode"))&&E.get(t)?.resolve()}function z(e,t,s=!1){const n={code:()=>{},type:e,op:t};if(t==="@init")return n;t===U&&(t="@init");const r=typeof e=="string"&&typeof t=="string"&&`${e}(${t})`,c=r&&V.get(r);if(c)return c;const i=je(e,t,s,n);return(!r||!i||!m[i.type].locked?!1:i.code.cache!==void 0?i.code.cache:i.op!==t||i.type!==e)&&V.set(r,i,i.code.cache==="pin"&&i.type===e),i}function je(e,t,s,n){let r,c;for(const i of L(e)){if(s&&i===e)continue;const o=m[i],f=o?.handlers[t];if(f)return{code:f,type:i,op:t};if(o&&!c){if(!r){const p="@defacc",M=o.handlers[p];M&&(r={code:M,type:i,op:p})}const l="@default",y=o.handlers[l];y&&(c={code:y,type:i,op:l})}}if(t==="@init")return n;if(!(c&&r&&!P(B,{op:"@defacc",octx:{},handler:r},{op:t,type:c.type})))return c}function C(e,t){const s=m[e];if(!s)throw new TypeError(`Cannot get instance for unknown Mesgjs interface "${e}"`);if(s.instance)return s.instance;const n=Object.create(null),r=function(i,o){return he({rr:r,rt:e,op:i,mp:o},{octx:n})};return T(r,"msjsType",e),s.singleton&&(s.instance=r),s.refd=!0,t instanceof d||(t=new d(t??[])),r(U,t),r}function x(e){if(e===":?")e=":?"+h++;else if(typeof e!="string"||!e||e.startsWith(":?")&&!m[e]||e[0]==="@"&&w!==1)return;const t=m[e],s=!t;if(s&&(m[e]={handlers:Object.create(null),chain:new Set([]),refd:!1,abstract:!1,final:!1,locked:!1,once:!1,pristine:!0,singleton:!1}),t?.once)return;const n={name:e,isFirst:s},r=n.bfn=Ie.bind(n);return T(r,{ifName:e,set:c=>ne(e,c,s),instance:c=>C(e,c),msjsType:"@interface"})}I.push(()=>{x("@interface").set({pristine:!0,private:!0,lock:!0}),se("@interface","instance","name","set")});function we(){return Object.isFrozen($)?$:void 0}function ye(e){const t=e.at("params",e);return t instanceof d?t:new d(t??[])}function $e(){w===2&&(w=1,I.forEach(e=>e()),globalThis.installMsjsCoreExtensions(),w=0,B.sr=B.rr=D.$c)}async function ee(e){if(H.has("mod-"+e))return;H.add("mod-"+e);const t=$.at("modules")?.at(e),s=t.at("integrity",""),n=s==="DISABLED"?"":oe(s);if(n){if(H.has(n))return;H.add(n)}else{if(globalThis.msjsHasModMeta&&s!=="DISABLED"){const f=new Error(`loadModule: Refusing unverified module "${e}"`);return console.error(f.message),f}console.warn(`loadModule WARNING: Module "${e}" is unverified`)}const r=Se(e,t);let c,i;const o=Symbol();X.set(o,e);try{c=await ce(r,{integrity:n}),t&&(n&&W.set(n,t),W.set(o,t));const l=await import(typeof Blob=="function"&&typeof URL?.createObjectURL=="function"?URL.createObjectURL(new Blob([new TextEncoder().encode(c)],{type:"application/javascript"})):`data:application/javascript;base64,${btoa(c)}`);globalThis.msjsHasModMeta&&l.loadMsjs&&l.loadMsjs(o)}catch(f){console.error(`loadModule "${e}" failed: ${f.message}`);for(const l of t?.at("featpro")?.values()||[])E.get(l)?.reject(c);return f}finally{i?.startsWith("blob:")&&URL.revokeObjectURL(i)}}function Me(){console.log(m)}function Te(e,t){return($?.at(["modules",e,"modcaps"])||[]).includes(t)}function ke(){const e=function(){},t=function(l){switch({op:l}=R({rr:t,op:l}),l){case"op":return"load";case"rr":case"sr":return e;case"rt":case"st":return"@module"}};let s,n;const r=f=>Z(f,t),c=J.bind({sr:e,st:"@module"}),i=()=>s??=new d,o=()=>n??=new d;return T(e,"msjsType","@module"),Object.defineProperties(e,{p:{get:i,enumerable:!0},t:{get:o,enumerable:!0}}),T(t,{sr:e,st:"@module",rr:e,rt:"@module",msjsType:"@dispatch",octx:D.$u,op:"load",mp:D.$u,b:r,sm:c}),Object.defineProperties(t,{p:{get:i,enumerable:!0},t:{get:o,enumerable:!0}}),{d:t,m:e,ls:_e,na:ze}}I.push(()=>{x("@module").set({pristine:!0,private:!0,lock:!0})});function Ee(e,t){const s={cd:e,od:t},n=s.bfn=Oe.bind(s);return T(n,"msjsType","@code")}function te(e,t){const s="@function",n={},r={octx:n,op:"call",handler:{code:e,type:s,op:"call"}};t!==void 0&&T(n,"ps",t);const c=r.bfn=Fe.bind(r);return r.sm=J.bind({sr:c,st:s}),T(c,"msjsType",s)}I.push(()=>{x("@code").set({pristine:!0,private:!0,lock:!0,handlers:{run:!1,fn:!1}}),x("@function").set({pristine:!0,private:!0,lock:!0,handlers:{call:!1,fn:!1}}),x("@handler").set({pristine:!0,private:!0,lock:!0})});function xe(e){const t=(s,n,r=/[\s,]+/)=>{const c=s.at(n);typeof c=="string"&&s.set(n,new d(c.split(r).filter(Boolean)))};for(const[s,n]of e?.namedEntries()||[]){const r=n.at("integrity");if(t(n,"featpro"),t(n,"featreq"),t(n,"modcaps"),r!=="DISABLED"&&!oe(r))continue;const c=n?.at("featpro",[]);Y(c)}}function Se(e,t){const s=t?.at("url");if(s)return s;const n=$.at("prefixMap");let r=["",0];for(const[o,f]of n.entries()){const l=o.length;l>r[1]&&e.startsWith(o)&&(r=[f,l])}e=r[0]+e.substring(r[1]);const c=t?.at("version"),[,i]=c&&c.match(/(\d+)/)||[];if(c&&i!==void 0){const[,o,f]=e.match(/(.*\/)?(.*)(?:(?:\.esm)?\.js)?$/);e=`${o}${f}/${i}/${f}@${c}`}return e.endsWith(".js")||(e+=".esm.js"),e}function Oe(e,t){const s=R({rr:this.bfn,op:e,mp:t}),{op:n,mp:r,hasElse:c,elseExpr:i}=s;if(n==="run")return this.cd(this.od);switch(n){case U:return;case K:a={code:this.cd};return;case"fn":return te(this.cd,r)}if(c)return O(i);throw new TypeError(`No Mesgjs handler found for "@code(${n})"`)}function Re(e,t,s){const{op:n,mp:r,elseExpr:c}=R({rr:this.bfn}),{octx:i,handler:o,sm:f}=t;switch(n){case"dop":return t.op;case"ht":return o.type;case"js":return i.js;case"log":console.dir(this.bfn,{depth:null});return;case"mop":return e.op;case"redis":{const l=r.has("else")?r.at("else"):c,y=r.at("type")||o.type;if(!L(o.type).has(y))return O(l);const p=r.has("op")?r.at("op"):o.op,M=ye(r),g=z(y,p,y===o.type&&p===o.op);return!g||!r.has("op")&&g.op!==p?O(l):P(e,{octx:i,op:p,handler:g,sm:f},M)}case"return":throw this.bfn._capture=!0,new A("return",r.at(0));case"rr":return e.rr;case"rt":return e.rt;case"sr":return e.sr;case"st":return e.st;case"smi":return e.smi}return O(c)}function Ce(...e){return this.bfn("call",new d([...e]))}function Fe(e,t){const s=R({rr:this.bfn,op:e,mp:t}),{op:n,mp:r,hasElse:c,elseExpr:i}=s;if(n==="call")return P(s,this,r);switch(n){case"fn":return te(this.handler.code,r);case"jsfn":return this.jsFn||=Ce.bind(this)}if(c)return O(i);throw new TypeError(`No Mesgjs handler found for "@function(${n})"`)}function Ie(e,t){const s=this.name,{op:n,mp:r,hasElse:c,elseExpr:i}=R({rr:this.bfn,op:e,mp:t});switch(n){case"instance":return C(s,r);case"name":return s;case"set":return ne(s,r,this.isFirst)}if(c)return O(i);throw new TypeError(`No Mesgjs handler found for "@interface(${n})"`)}function J(e,t,s){e?.msjsType||(e=D.$toMsjs(e)),u={sr:this.sr,st:this.st,rr:e,op:t,mp:s};let n;try{n=e()}finally{u=void 0}return n}function ne(e,t,s){if(e[0]==="@"&&w!==1)throw new TypeError(`Cannot configure Mesgjs interface "${e}" after runtime initialization`);const n=m[e];if(t instanceof d&&(t=t.storage),t.once&&!s||t.pristine&&!n.pristine)throw new TypeError(`Mesgjs interface "${e}" is not pristine`);if(n.pristine=!1,n.locked)throw new TypeError(`Cannot change locked Mesgjs interface "${e}"`);if(t.chain){if(n.chain.size)throw new TypeError(`Cannot change chain for Mesgjs interface "${e}"`);if(n.refd)throw new TypeError(`Cannot set chain for active Mesgjs interface "${e}"`);const i=new Set(Object.values(t.chain.storage||t.chain||[]));for(const o of i){if(!m[o])throw new ReferenceError(`Mesgjs interface "${e}" references unknown interface "${o}"`);if(m[o].final)throw new TypeError(`Mesgjs interface "${e}" tries to extend final interface "${o}"`);m[o].refd=!0}n.chain=i}const r=t.handlers||{};for(const[i,o]of r instanceof d?r.entries():Object.entries(r))typeof o=="function"?o.msjsType==="@code"?(a=void 0,o(K),a?.code&&T(n.handlers[i]=a.code,"msjsType","@handler")):n.handlers[i]=o:o===!1&&(n.handlers[i]=!1);a=void 0;const c=t.cacheHints||{};for(const[i,o]of c instanceof d?c.entries():Object.entries(c))switch(o){case!0:case!1:case"pin":n.handlers[i]&&(n.handlers[i].cache=o);break}t.init&&(n.init=t.init),t.abstract&&(n.abstract=!0),t.final&&(n.final=!0),t.lock&&(n.locked=!0),t.once&&(n.once=!0),t.singleton&&(n.singleton=!0)}function ve(e){if(globalThis.msjsHasModMeta)return;if(e instanceof d)$.push(Ue(e.toSLID()));else if(typeof e=="object")$.push(Ae(JSON.stringify(e)));else return;T(globalThis,{msjsHasModMeta:!0,msjsNoSelfLoad:!0}),xe($.at("modules")),$.at("testMode")&&Y($.at("features",[])),$.set("allFeatures",new d(...E.keys())),$.deepFreeze();const t=C("@promise"),s=[];E.set("@loaded",t);for(const n of $.at("modules")?.entries()||[])n[1].at("deferLoad")||s.push(ee(n[0]));t.allSettled(s)}function se(e,...t){const s=m[e]?.handlers;s&&t.forEach(n=>s[n]=!1)}function De(e,t){if(t===void 0){const n=m[e];return n&&!n.private?[...Object.keys(n.handlers)]:void 0}const s=z(e,t);if(s)return[s.type,s.op==="@default"?"default":"specific"]}function He(e,t){if(!m[e]?.private)return t===void 0?m[e]?Array.from(m[e].chain):void 0:L(e).has(t)}return{debugConfig:de,fcheck:ge,fready:be,fwait:me,getInstance:le,getInterface:x,getModMeta:we,initialize:$e,logInterfaces:Me,loadModule:ee,modHasCap:Te,moduleScope:ke,setModMeta:ve,typeAccepts:De,typeChains:He}})();T(globalThis,{$f:!1,$gss:new d,$n:null,$t:!0,$u:void 0,$modScope:Ge});export{A as MsjsFlow,We as MsjsFlowError,Ze as calcIntegrity,nt as debugConfig,st as fcheck,ce as fetchModule,rt as fready,ot as fwait,it as getInstance,ct as getInterface,at as getModMeta,ft as initialize,_e as listFromPairs,ut as loadModule,lt as logInterfaces,G as loggedType,dt as modHasCap,Ge as moduleScope,ze as namespaceAt,O as runIfCode,et as runWhileCode,Je as sendAnonMessage,ae as senderFLC,pt as setModMeta,T as setRO,tt as throwFlow,ht as typeAccepts,gt as typeChains};
