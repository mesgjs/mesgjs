import{calcDigest as oe,getIntegritySHA512 as ie}from"./calc-digest.esm.js";import{NANOS as d,isIndex as Ae,parseQJSON as Ue,parseSLID as Be}from"./vendor.esm.js";import{SieveCache as We}from"./sieve-cache.esm.js";import{unifiedList as ae}from"./unified-list.esm.js";import"./shim.esm.js";const H=globalThis;class B extends Error{get name(){return"MsjsFlow"}}class ze extends RangeError{get name(){return"MsjsFlowError"}}async function et(c){return oe(await ce(c,{decode:!1}),"SHA-512")}async function ce(c,{decode:u,integrity:h}={}){let b;if(typeof Deno<"u"&&!c.startsWith("https://")&&!c.startsWith("data:")){if(b=await Deno.readFile(c),!b)throw new Error(`fetchModule: File "${c}" not found`)}else b=await fetch(c).then(j=>{if(j.ok)return j.arrayBuffer();throw new Error(`fetchModule: File "${c}" not found`)});return h&&await oe(b,"SHA-512")!==h?new Error(`fetchModule: File "${c}" integrity verification failed`):u===!1?b:new TextDecoder().decode(b)}const Je=c=>new d().fromPairs(c);function Q(c){if(c?.msjsType)return"M."+c.msjsType;const u=typeof c;switch(u){case"boolean":return c?"@t":"@f";case"undefined":return"@u";case"object":return c===null?"@n":"J."+(c?.constructor?.name||"Object");default:return"J."+u}}function _e(c,u,h){if(c?.has&&c.has(u))return c.at(u);if(!h)throw new ReferenceError(`Required key "${u}" not found`)}const O=c=>c?.msjsType==="@code"?c("run"):c;function tt(c){for(;c?.msjsType==="@code";)c=c("run");return c}function qe(c,u,h){return c?.msjsType||(c=H.$toMsjs(c)),c(u,h)}function fe(){const c=(new Error().stack||"").split(`
`);for(;c.length&&!/msjsR\$/.test(c.shift()););for(;/msjsS\$/.test(c[0]);)c.shift();const u=c[0]||"",h=u.match(/[@(](.*):(\d+):(\d+)/)||u.match(/(?:^|\s+)at\s+(.*):(\d+):(\d+)$/);if(h)return{file:h[1],line:parseInt(h[2]),column:parseInt(h[3])}}const F={writable:!1,configurable:!1},T=(c,...u)=>{if(typeof u[0]=="object"){const[h,b=!0]=u;F.enumerable=b;for(const j of Object.keys(h))F.value=h[j],Object.defineProperty(c,j,F)}else{const[h,b,j=!0]=u;[F.value,F.enumerable]=[b,j],Object.defineProperty(c,h,F)}return c};function nt(c,u,h){const{js:b,mp:j}=c;throw b.active?(b.capture=!0,j.has("result")&&(b.hasFlowRes=!0,b.flowRes=j.at("result")),new B(u)):new ze(`(${u}) to inactive ${h}`)}const Ge=Object.hasOwn,{debugConfig:st,fcheck:rt,fready:ot,fwait:it,getInstance:at,getInterface:ct,getModMeta:ft,initialize:ut,loadModule:lt,logInterfaces:dt,modHasCap:pt,moduleScope:Ke,setModMeta:ht,typeAccepts:gt,typeChains:mt}=(()=>{let c,u,h=0,b=0,j=2,ue=0;const V=Symbol("getCode"),P=Symbol("@init"),m=Object.create(null),I=[],w=Object.setPrototypeOf({dispatch:!1,dispatchSource:!1,dispatchTypes:!1,stack:0,stackSource:!1,stackTypes:!1},null),v=[],X="-- Mesgjs Dispatch Stack --",Y=new We(1024),W={st:"@core",rt:"@core",sm:qe},E=new Map,L=new d,$=new d,z=new Map,D=new Set,Z=new Map;function ee(e,t,s){if(typeof e=="string"&&(e=e.split(/\s+/).filter(Boolean)),typeof e?.values=="function"){for(const n of e.values())if(!E.has(n)){const r=C("@promise");r.catch(()=>console.warn(`loadModule: Feature "${n}" rejected`)),E.set(n,r),L.push(n),t&&s&&L.set(n,new d({[s.at("deferLoad")?"defer":"preload"]:t}))}}}function le(e){if(!v.length||!e.stack?.includes||e.stack.includes(X))return;const t=[],s=w.stack;let n=v.length;for(let r=0;--n>=0;){const i=v[n],o=i.disp,a=typeof o.op=="symbol"?"J.Symbol":o.op;if(t.push(`${o.st} => ${o.rt}(${a}${U(w.stackTypes,o.mp)})${J(w.stackSource,i)}`),++r===s)break}n>=0&&t.push("[...]"),e.stack+=`
`+X+`
`+t.join(`
`)}function te(e,t){return e.ucid===void 0&&T(e,"ucid",b++),(t._bc||=[])[e.ucid]||=xe(e.cd,t)}function R(e,t=!0){let s,n,r,{rr:i,rt:o,op:a,mp:f}=e,l=!1,y;if(t){const p=u;u=void 0,a===void 0&&p?.rr===i&&({sr:s,st:n,op:a,mp:f}=p)}if(a instanceof d&&(a=a.storage),typeof a=="object"){const p=M=>Ge(a,M);if(p("else")&&([l,y]=[!0,a.else]),p("mid")){const M=Z.get(a.mid);M&&(r=M)}if(p("params")&&(f=a.params),p("op"))a=a.op;else if(p("0"))a=a[0];else throw new SyntaxError("Missing operation in Mesgjs list-op message")}return f instanceof d||(f=new d(f??[])),{sr:s,st:n,smi:r,rr:i,rt:o,op:a,mp:f,hasElse:l,elseExpr:y}}function de(e,t){const s=m[e];if(s&&!s.private)return C(e,t)}function pe(e){e=ae(e);for(const t of Object.keys(w)){const s=typeof w[t];switch(s){case"boolean":e?.has?.(t)&&(w[t]=!!e.at(t));break;case"number":{const n=e?.at?.(t);typeof n===s&&(w[t]=n);break}}}return new d(w)}const he=Object.setPrototypeOf({b(e){return te(e,this)},get js(){return this.octx.js},get p(){return this.octx.ps??=new d},get msjsType(){return"@dispatch"},get t(){return this._ts??=new d}},Object.getPrototypeOf(Function));function N(e,t,s){const{sr:n,st:r,smi:i,rr:o,rt:a}=e,{op:f,octx:l,handler:y,sm:p}=t,M={},g=M.bfn=Object.setPrototypeOf(Ce.bind(M,e,t,s),he);g.dop=f,g.ht=y.type,g.mop=e.op,g.mp=s,g.octx=l,g.rr=o,g.rt=a,g.sm=p,g.sr=n,g.st=r,g.smi=i;const K=w.stack,S=w.dispatch&&(ue++).toString(16);try{if(w.dispatch){const Le=typeof f=="symbol"?"J.Symbol":f,Ne=Q(r);console.log(`[Mesgjs dispatch ${S}] ${Ne} => ${a}${y.type===a?"":"/"+y.type}(${Le}${U(w.dispatchTypes,g.mp)})${J(w.dispatchSource)}`)}K&&v.push({disp:g,...w.stackSource&&fe()||{}});const k=y.code(g);return S!==!1&&console.log(`[Mesgjs return ${S}]${U(w.dispatchTypes,[k])}`),k}catch(k){if(g._capture&&k instanceof B)return g._capture=!1,S!==!1&&console.log(`[Mesgjs return ${S}]${U(w.dispatchTypes,[k.info])}`),k.info;throw S!==!1&&console.warn(`[Mesgjs exception ${S}]`,k),K&&!(k instanceof B)&&le(k),k}finally{K&&v.pop()}}function ge(e,t){const s=R(e),{st:n,rr:r,rt:i,op:o,mp:a,hasElse:f,elseExpr:l}=s,{octx:y,handler:p=_(i,o)}=t;if(!p){if(w.dispatch&&console.log(`[Mesgjs dispatch] ${n} => ${i}(${o}) [NO HANDLER]${J(w.dispatchSource)}`),f)return O(l);throw new TypeError(`No Mesgjs handler found for "${i}(${o})"`)}const M=G.bind({sr:r,st:i});return N(s,{octx:y,op:o,handler:p,sm:M},a)}I.push(()=>{x("@dispatch").set({pristine:!0,private:!0,lock:!0}),re("@dispatch","ht","js","op","redis","return","rr","rt","sr","st","smi")});function A(e){const t=m[e];if(!t)return new Set;let s=t.flatChain;if(!s){s=new Set([e]);for(const n of t.chain)s.has(n)||(s=s.union(A(n)));t.flatChain=s}return s}function U(e,t){return e?[...ae(t).entries()].map(s=>Ae(s[0])?` ${Q(s[1])}`:` ${s[0]}=${Q(s[1])}`).join(""):""}function J(e,t){return e&&(t||(t=fe()),t?.line!==void 0)?` at ${t.file}:${t.line}:${t.column}`:""}function me(e){switch(E.get(e)?.state){case"pending":return!1;case"fulfilled":return!0}}function we(...e){const t=new Set(e),s=i=>{if(!D.has("mod-"+i)){q(i);for(const o of $.at(["modules",i,"featreq"],[]).values())t.add(o)}};for(const i of t){const o=L.at([i,"defer"]);o&&s(o)}const n=C("@promise"),r=[];n.catch(()=>{});for(const i of t)E.has(i)&&r.push(E.get(i));return n.all(r)}function be(e,t){(z.get(e)?.at("featpro")?.includes(t)||$.at("testMode"))&&E.get(t)?.resolve()}function _(e,t,s=!1){const n={code:()=>{},type:e,op:t};if(t==="@init")return n;t===P&&(t="@init");const r=typeof e=="string"&&typeof t=="string"&&`${e}(${t})`,i=r&&Y.get(r);if(i)return i;const o=je(e,t,s,n);return(!r||!o||!m[o.type].locked?!1:o.code.cache!==void 0?o.code.cache:o.op!==t||o.type!==e)&&Y.set(r,o,o.code.cache==="pin"&&o.type===e),o}function je(e,t,s,n){let r,i;for(const o of A(e)){if(s&&o===e)continue;const a=m[o],f=a?.handlers[t];if(f)return{code:f,type:o,op:t};if(a&&!i){if(!r){const p="@defacc",M=a.handlers[p];M&&(r={code:M,type:o,op:p})}const l="@default",y=a.handlers[l];y&&(i={code:y,type:o,op:l})}}if(t==="@init")return n;if(!(i&&r&&!N(W,{op:"@defacc",octx:{},handler:r},{op:t,type:i.type})))return i}function C(e,t,{sr:s,st:n}={}){const r=m[e];if(!r)throw new TypeError(`Cannot get instance for unknown Mesgjs interface "${e}"`);if(r.instance)return r.instance;if(r.abstract)throw new TypeError(`Cannot get instance for abstract Mesgjs interface "${e}"`);const i=Object.create(null),o=function(f,l){return ge({rr:o,rt:e,op:f,mp:l},{octx:i})};if(T(o,"msjsType",e),r.singleton&&(r.instance=o),r.locked=!0,t instanceof d||(t=new d(t??[])),typeof s=="function"&&typeof n=="string")try{u={sr:s,st:n,rr:o,op:P,mp:t},o()}finally{u=void 0}else o(P,t);return o}function x(e){if(e===":?")e=":?"+h++;else if(typeof e!="string"||!e||e.startsWith(":?")&&!m[e])return;if(e[0]==="@"&&j!==1&&!m[e])return;const t=m[e],s=!t;if(s&&(m[e]={handlers:Object.create(null),chain:new Set([]),refd:!1,abstract:!1,final:!1,locked:!1,once:!1,pristine:!0,singleton:!1}),t?.once)return;const n={name:e,isFirst:s},r=n.bfn=ve.bind(n);return T(r,{ifName:e,set:i=>se(e,i,s),instance:i=>C(e,i),msjsType:"@interface"})}I.push(()=>{x("@interface").set({pristine:!0,private:!0,lock:!0}),re("@interface","instance","name","set")});function ye(){return Object.isFrozen($)?$:void 0}function $e(e){const t=e.at("params",e);return t instanceof d?t:new d(t??[])}function Me(e){j===2&&(j=1,I.forEach(t=>t()),e(),j=0,W.sr=W.rr=H.$c)}async function q(e){if(D.has("mod-"+e))return;D.add("mod-"+e);const t=$.at(["modules",e]),s=t.at("integrity",""),n=s==="DISABLED"?"":ie(s);if(n){if(D.has(n))return;D.add(n)}else{if(globalThis.msjsHasModMeta&&s!=="DISABLED"){const f=new Error(`loadModule: Refusing unverified module "${e}"`);return console.error(f.message),f}console.warn(`loadModule WARNING: Module "${e}" is unverified`)}const r=Oe(e,t);let i,o;const a=Symbol();Z.set(a,e);try{i=await ce(r,{integrity:n}),t&&(n&&z.set(n,t),z.set(a,t));const l=await import(typeof Blob=="function"&&typeof URL?.createObjectURL=="function"?URL.createObjectURL(new Blob([new TextEncoder().encode(i)],{type:"application/javascript"})):`data:application/javascript;base64,${btoa(i)}`);globalThis.msjsHasModMeta&&l.loadMsjs&&l.loadMsjs(a)}catch(f){console.error(`loadModule "${e}" failed: ${f.message}`);for(const l of t?.at("featpro")?.values()||[])E.get(l)?.reject(i);return f}finally{o?.startsWith("blob:")&&URL.revokeObjectURL(o)}}function Te(){console.log(m)}function ke(e,t){return($?.at(["modules",e,"modcaps"])||[]).includes(t)}function Ee(){const e=function(){},t=function(l){switch({op:l}=R({rr:t,op:l}),l){case"op":return"load";case"rr":case"sr":return e;case"rt":case"st":return"@module"}};let s,n;const r=f=>te(f,t),i=G.bind({sr:e,st:"@module"}),o=()=>s??=new d,a=()=>n??=new d;return T(e,"msjsType","@module"),Object.defineProperties(e,{p:{get:o,enumerable:!0},t:{get:a,enumerable:!0}}),T(t,{sr:e,st:"@module",rr:e,rt:"@module",msjsType:"@dispatch",octx:H.$u,op:"load",mp:H.$u,b:r,sm:i}),Object.defineProperties(t,{p:{get:o,enumerable:!0},t:{get:a,enumerable:!0}}),{d:t,m:e,ls:Je,na:_e}}I.push(()=>{x("@module").set({pristine:!0,private:!0,lock:!0})});function xe(e,t){const s={cd:e,od:t},n=s.bfn=Re.bind(s);return T(n,"msjsType","@code")}function ne(e,t){const s="@function",n={},r={octx:n,op:"call",handler:{code:e,type:s,op:"call"}};t!==void 0&&T(n,"ps",t);const i=r.bfn=Ie.bind(r);return r.sm=G.bind({sr:i,st:s}),T(i,"msjsType",s)}I.push(()=>{x("@code").set({pristine:!0,private:!0,lock:!0,handlers:{run:!1,fn:!1}}),x("@function").set({pristine:!0,private:!0,lock:!0,handlers:{call:!1,fn:!1}}),x("@handler").set({pristine:!0,private:!0,lock:!0})});function Se(e){const t=(s,n,r=/[\s,]+/)=>{const i=s.at(n);typeof i=="string"&&s.set(n,new d(i.split(r).filter(Boolean)))};for(const[s,n]of e?.namedEntries()||[]){const r=n.at("integrity");if(t(n,"featpro"),t(n,"featreq"),t(n,"modcaps"),r!=="DISABLED"&&!ie(r))continue;const i=n?.at("featpro",[]);ee(i,s,n)}}function Oe(e,t){const s=t?.at("url");if(s)return s;const n=$.at("prefixMap");let r=["",0];for(const[a,f]of n.entries()){const l=a.length;l>r[1]&&e.startsWith(a)&&(r=[f,l])}e=r[0]+e.substring(r[1]);const i=t?.at("version"),[,o]=i&&i.match(/(\d+)/)||[];if(i&&o!==void 0){const[,a,f]=e.match(/(.*\/)?(.*)(?:(?:\.esm)?\.js)?$/);e=`${a}${f}/${o}/${f}@${i}`}return e.endsWith(".js")||(e+=".esm.js"),e}function Re(e,t){const s=R({rr:this.bfn,op:e,mp:t}),{op:n,mp:r,hasElse:i,elseExpr:o}=s;if(n==="run")return this.cd(this.od);switch(n){case P:return;case V:c={code:this.cd};return;case"fn":return ne(this.cd,r)}if(i)return O(o);throw new TypeError(`No Mesgjs handler found for "@code(${n})"`)}function Ce(e,t,s){const{op:n,mp:r,elseExpr:i}=R({rr:this.bfn}),{octx:o,handler:a,sm:f}=t;switch(n){case"dop":return t.op;case"ht":return a.type;case"js":return o.js;case"log":console.dir(this.bfn,{depth:null});return;case"mop":return e.op;case"redis":{const l=r.has("else")?r.at("else"):i,y=r.at("type")||a.type;if(!A(a.type).has(y))return O(l);const p=r.has("op")?r.at("op"):a.op,M=$e(r),g=_(y,p,y===a.type&&p===a.op);return!g||!r.has("op")&&g.op!==p?O(l):N(e,{octx:o,op:p,handler:g,sm:f},M)}case"return":throw this.bfn._capture=!0,new B("return",r.at(0));case"rr":return e.rr;case"rt":return e.rt;case"sr":return e.sr;case"st":return e.st;case"smi":return e.smi}return O(i)}function Fe(...e){return this.bfn("call",new d([...e]))}function Ie(e,t){const s=R({rr:this.bfn,op:e,mp:t}),{op:n,mp:r,hasElse:i,elseExpr:o}=s;if(n==="call")return N(s,this,r);switch(n){case"fn":return ne(this.handler.code,r);case"jsfn":return this.jsFn||=Fe.bind(this)}if(i)return O(o);throw new TypeError(`No Mesgjs handler found for "@function(${n})"`)}function ve(e,t){const s=this.name,{op:n,mp:r,sr:i,st:o,hasElse:a,elseExpr:f}=R({rr:this.bfn,op:e,mp:t});switch(n){case"instance":return C(s,r,{sr:i,st:o});case"name":return s;case"set":return se(s,r,this.isFirst)}if(a)return O(f);throw new TypeError(`No Mesgjs handler found for "@interface(${n})"`)}function G(e,t,s){e?.msjsType||(e=H.$toMsjs(e)),u={sr:this.sr,st:this.st,rr:e,op:t,mp:s};let n;try{n=e()}finally{u=void 0}return n}function se(e,t,s){if(e[0]==="@"&&j!==1)throw new TypeError(`Cannot configure Mesgjs interface "${e}" after runtime initialization`);const n=m[e];if(t instanceof d&&(t=t.storage),t.once&&!s||t.pristine&&!n.pristine)throw new TypeError(`Mesgjs interface "${e}" is not pristine`);if(n.pristine=!1,n.locked)throw new TypeError(`Cannot change locked Mesgjs interface "${e}"`);if(t.chain){if(n.chain.size)throw new TypeError(`Cannot change chain for Mesgjs interface "${e}"`);if(n.refd)throw new TypeError(`Cannot set chain for active Mesgjs interface "${e}"`);const o=new Set(Object.values(t.chain.storage||t.chain||[]));for(const a of o){if(!m[a])throw new ReferenceError(`Mesgjs interface "${e}" references unknown interface "${a}"`);if(m[a].final)throw new TypeError(`Mesgjs interface "${e}" tries to extend final interface "${a}"`);m[a].refd=!0}n.chain=o}const r=t.handlers||{};for(const[o,a]of r instanceof d?r.entries():Object.entries(r))typeof a=="function"?a.msjsType==="@code"?(c=void 0,a(V),c?.code&&T(n.handlers[o]=c.code,"msjsType","@handler")):n.handlers[o]=a:a===!1&&(n.handlers[o]=!1);c=void 0;const i=t.cacheHints||{};for(const[o,a]of i instanceof d?i.entries():Object.entries(i))switch(a){case!0:case!1:case"pin":n.handlers[o]&&(n.handlers[o].cache=a);break}t.init&&(n.init=t.init),t.abstract&&(n.abstract=!0),t.final&&(n.final=!0),t.lock&&(n.locked=!0),t.once&&(n.once=!0),t.private&&(n.private=!0),t.singleton&&(n.singleton=!0)}function De(e){if(globalThis.msjsHasModMeta)return;if(e instanceof d)$.push(Be(e.toSLID()));else if(typeof e=="object")$.push(Ue(JSON.stringify(e)));else return;T(globalThis,{msjsHasModMeta:!0,msjsNoSelfLoad:!0}),Se($.at("modules")),$.at("testMode")&&ee($.at("features",[])),$.set("allFeatures",L),$.deepFreeze();const t=C("@promise"),s=[];E.set("@loaded",t);for(const[n,r]of $.at("modules")?.entries()||[])r.at("deferLoad")||s.push(q(n));t.allSettled(s)}function re(e,...t){const s=m[e]?.handlers;s&&t.forEach(n=>s[n]=!1)}function He(e,t){if(t===void 0){const n=m[e];return n&&!n.private?[...Object.keys(n.handlers)]:void 0}const s=_(e,t);if(s)return[s.type,s.op==="@default"?"default":"specific"]}function Pe(e,t){if(!m[e]?.private)return t===void 0?m[e]?Array.from(m[e].chain):void 0:A(e).has(t)}return{debugConfig:pe,fcheck:me,fready:be,fwait:we,getInstance:de,getInterface:x,getModMeta:ye,initialize:Me,logInterfaces:Te,loadModule:q,modHasCap:ke,moduleScope:Ee,setModMeta:De,typeAccepts:He,typeChains:Pe}})();T(globalThis,{$f:!1,$gss:new d,$n:null,$t:!0,$u:void 0,$modScope:Ke});export{B as MsjsFlow,ze as MsjsFlowError,et as calcIntegrity,st as debugConfig,rt as fcheck,ce as fetchModule,ot as fready,it as fwait,at as getInstance,ct as getInterface,ft as getModMeta,ut as initialize,Je as listFromPairs,lt as loadModule,dt as logInterfaces,Q as loggedType,pt as modHasCap,Ke as moduleScope,_e as namespaceAt,O as runIfCode,tt as runWhileCode,qe as sendAnonMessage,fe as senderFLC,ht as setModMeta,T as setRO,nt as throwFlow,gt as typeAccepts,mt as typeChains};
