import{calcDigest as te,getIntegritySHA512 as ne}from"./calc-digest.esm.js";import{NANOS as h,isIndex as Ie,parseQJSON as ve,parseSLID as He}from"./vendor.esm.js";import{SieveCache as Pe}from"./sieve-cache.esm.js";import{unifiedList as se}from"./unified-list.esm.js";import"./shim.esm.js";const P=globalThis;class J extends Error{constructor(f,l){super(f),l!==void 0&&(this.info=l)}get name(){return"MsjsFlow"}}class De extends RangeError{constructor(...f){super(...f),this.name="MsjsFlowError"}}async function Ke(i){return te(await re(i,{decode:!1}),"SHA-512")}async function re(i,f,{decode:l,integrity:y}={}){const m=i?`${i}/${f}`:f;let T;return i&&(T=await fetch(m).arrayBuffer()),typeof Deno<"u"&&(T=await Deno.readFile(f)),T?y&&await te(T,"SHA-512")!==y?new Error(`fetchModule: File "${m}" integrity verification failed`):l===!1?T:new TextDecoder().decode(T):new Error(`fetchModule: File "${f}" not found`)}const Ne=i=>new h().fromPairs(i);function oe(i){if(i?.msjsType)return"S."+i.msjsType;const f=typeof i;switch(f){case"boolean":return i?"@t":"@f";case"undefined":return"@u";case"object":return i===null?"@n":"J."+(i?.constructor?.name||"Object");default:return"J."+f}}function Le(i,f,l){if(i?.has&&i.has(f))return i.at(f);if(!l)throw new ReferenceError(`Required key "${f}" not found`)}const O=i=>i?.msjsType==="@code"?i("run"):i;function qe(i){for(;i?.msjsType==="@code";)i=i("run");return i}function Ae(i,f,l){return i?.msjsType||(i=P.$toMsjs(i)),i(f,l)}function ie(){const i=(new Error().stack||"").split(`
`);for(;i.length&&!/msjsR\$/.test(i.shift()););for(;/msjsS\$/.test(i[0]);)i.shift();const f=i[0]||"",l=f.match(/[@(](.*):(\d+):(\d+)/)||f.match(/(?:^|\s+)at\s+(.*):(\d+):(\d+)$/);if(l)return{file:l[1],line:parseInt(l[2]),column:parseInt(l[3])}}const I={writable:!1,configurable:!1},$=(i,...f)=>{if(typeof f[0]=="object"){const[l,y=!0]=f;I.enumerable=y;for(const m of Object.keys(l))I.value=l[m],Object.defineProperty(i,m,I)}else{const[l,y,m=!0]=f;[I.value,I.enumerable]=[y,m],Object.defineProperty(i,l,I)}return i};function Qe(i,f,l){const{js:y,mp:m}=i;throw y.active?(y.capture=!0,m.has("result")&&(y.hasFlowRes=!0,y.flowRes=m.at("result")),new J(f)):new De(`(${f}) to inactive ${l}`)}const Je=Object.hasOwn,{debugConfig:Ve,fcheck:Xe,fready:Ye,fwait:Ze,getInstance:et,getInterface:tt,initialize:nt,loadModule:st,logInterfaces:rt,moduleScope:Ue,setModMeta:ot,typeAccepts:it,typeChains:ct}=(()=>{let i,f,l=0,y=0,m=2,T=0;const K=Symbol("getCode"),U=Symbol("@init"),g=Object.create(null),v=[],b=Object.setPrototypeOf({dispatch:!1,dispatchSource:!1,dispatchTypes:!1,stack:0,stackSource:!1,stackTypes:!1},null),H=[],q="-- Mesgjs Dispatch Stack --",Q=new Pe(1024),_={st:"@core",rt:"@core",sm:Ae},D=new Set,k=new Map,C=new h,B=new Map;function ce(e){for(const t of e.keys()||[]){const n=e.at(t);if(ne(n?.at("integrity"))){for(const s of n?.at("featpro")?.values()||[])if(!k.has(s)){const o=F("@promise");o.catch(()=>console.log(`loadModule: Feature "${s}" rejected`)),k.set(s,o)}}}}function ae(e){if(!H.length||!e.stack?.includes||e.stack.includes(q))return;const t=[],n=b.stack;let s=H.length;for(let o=0;--s>=0;){const c=H[s],r=c.disp,a=typeof r.op=="symbol"?"J.Symbol":r.op;if(t.push(`${r.st} => ${r.rt}(${a}${A(b.stackTypes,r.mp)})${W(b.stackSource,c)}`),++o===n)break}s>=0&&t.push("[...]"),e.stack+=`
`+q+`
`+t.join(`
`)}function V(e,t){return e.ucid===void 0&&$(e,"ucid",y++),(t._bc||=[])[e.ucid]||=$e(e.cd,t)}function R(e,t=!0){let n,s,{rr:o,rt:c,op:r,mp:a}=e,p=!1,d;if(t){const j=f;f=void 0,r===void 0&&j?.rr===o&&({sr:n,st:s,op:r,mp:a}=j)}if(r instanceof h&&(r=r.storage),typeof r=="object"){const j=w=>Je(r,w);if(j("else")&&([p,d]=[!0,r.else]),j("params")&&(a=r.params),j("op"))r=r.op;else if(j("0"))r=r[0];else throw new SyntaxError("Missing operation in Mesgjs list-op message")}return a instanceof h||(a=new h(a??[])),{sr:n,st:s,rr:o,rt:c,op:r,mp:a,hasElse:p,elseExpr:d}}function fe(e,t){const n=g[e];if(n&&!n.private)return F(e,t)}function ue(e){e=se(e);for(const t of Object.keys(b)){const n=typeof b[t];switch(n){case"boolean":e.has(t)&&(b[t]=!!e.at(t));break;case"number":{const s=e.at(t);typeof s===n&&(b[t]=s);break}}}return new h(b)}const le=Object.setPrototypeOf({b(e){return V(e,this)},get js(){return this.octx.js},get p(){return this.octx.ps??=new h},get msjsType(){return"@dispatch"},get t(){return this._ts??=new h}},Object.getPrototypeOf(Function));function N(e,t,n){const{sr:s,st:o,rr:c,rt:r}=e,{op:a,octx:p,handler:d,sm:j}=t,w={},u=w.bfn=Object.setPrototypeOf(ke.bind(w,e,t,n),le);u.dop=a,u.ht=d.type,u.mop=e.op,u.mp=n,u.octx=p,u.rr=c,u.rt=r,u.sm=j,u.sr=s,u.st=o;const E=b.stack,S=b.dispatch&&(T++).toString(16);try{if(b.dispatch){const Fe=typeof u.op=="symbol"?"J.Symbol":u.op;console.log(`[Mesgjs dispatch ${S}] ${o} => ${r}${d.type===r?"":"/"+d.type}(${Fe}${A(b.dispatchTypes,u.mp)})${W(b.dispatchSource)}`)}E&&H.push({disp:u,...b.stackSource&&ie()||{}});const M=d.code(u);return S!==!1&&console.log(`[Mesgjs return ${S}]${A(b.dispatchTypes,[M])}`),M}catch(M){if(u._capture&&M instanceof J)return u._capture=!1,S!==!1&&console.log(`[Mesgjs return ${S}]${A(b.dispatchTypes,[M.info])}`),M.info;throw S!==!1&&console.log(`[Mesgjs exception ${S}]`,M),E&&!(M instanceof J)&&ae(M),M}finally{E&&H.pop()}}function de(e,t){const n=R(e),{st:s,rr:o,rt:c,op:r,mp:a,hasElse:p,elseExpr:d}=n,{octx:j,handler:w=z(c,r)}=t;if(!w){if(b.dispatch&&console.log(`[Mesgjs dispatch] ${s} => ${c}(${r}) [NO HANDLER]${W(b.dispatchSource)}`),p)return O(d);throw new TypeError(`No Mesgjs handler found for "${c}(${r})"`)}const u=G.bind({sr:o,st:c});return N(n,{octx:j,op:r,handler:w,sm:u},a)}v.push(()=>{x("@dispatch").set({pristine:!0,private:!0,lock:!0}),ee("@dispatch","ht","js","op","redis","return","rr","rt","sr","st")});function L(e){const t=g[e];if(!t)return new Set;let n=t.flatChain;if(!n){n=new Set([e]);for(const s of t.chain)n.has(s)||(n=n.union(L(s)));t.flatChain=n}return n}function A(e,t){return e?[...se(t).entries()].map(n=>Ie(n[0])?` ${oe(n[1])}`:` ${n[0]}=${oe(n[1])}`).join(""):""}function W(e,t){return e&&(t||(t=ie()),t?.line!==void 0)?` at ${t.file}:${t.line}:${t.column}`:""}function pe(e){switch(k.get(e)?.state){case"pending":return!1;case"resolved":return!0}}function he(...e){const t=F("@promise"),n=[];t.catch(()=>{});for(const s of e)k.has(s)&&n.push(k.get(s));return t.all(n)}function ge(e,t){const n=B.get(e);n&&n.featpro?.includes(t)&&k.get(t)?.resolve()}function z(e,t,n=!1){const s={code:()=>{},type:e,op:t};if(t==="@init")return s;t===U&&(t="@init");const o=typeof e=="string"&&typeof t=="string"&&`${e}(${t})`,c=o&&Q.get(o);if(c)return c;const r=be(e,t,n,s);return(!o||!r||!g[r.type].locked?!1:r.code.cache!==void 0?r.code.cache:r.op!==t||r.type!==e)&&Q.set(o,r,r.code.cache==="pin"&&r.type===e),r}function be(e,t,n,s){let o,c;for(const r of L(e)){if(n&&r===e)continue;const a=g[r],p=a?.handlers[t];if(p)return{code:p,type:r,op:t};if(a&&!c){if(!o){const w="@defacc",u=a.handlers[w];u&&(o={code:u,type:r,op:w})}const d="@default",j=a.handlers[d];j&&(c={code:j,type:r,op:d})}}if(t==="@init")return s;if(!(c&&o&&!N(_,{op:"@defacc",octx:{},handler:o},{op:t,type:c.type})))return c}function F(e,t){const n=g[e];if(!n)throw new TypeError(`Cannot get instance for unknown Mesgjs interface "${e}"`);if(n.instance)return n.instance;const s=Object.create(null),o=function(r,a){return de({rr:o,rt:e,op:r,mp:a},{octx:s})};return $(o,"msjsType",e),n.singleton&&(n.instance=o),n.refd=!0,t instanceof h||(t=new h(t??[])),o(U,t),o}function x(e){if(e==="?")e="?"+l++;else if(typeof e!="string"||!e||e[0]==="?"&&!g[e]||e[0]==="@"&&m!==1)return;const t=g[e],n=!t;if(n&&(g[e]={handlers:Object.create(null),chain:new Set([]),refd:!1,abstract:!1,final:!1,locked:!1,once:!1,pristine:!0,singleton:!1}),t?.once)return;const s={name:e,isFirst:n},o=s.bfn=Se.bind(s);return $(o,{ifName:e,set:c=>Z(e,c,n),instance:c=>F(e,c),msjsType:"@interface"})}v.push(()=>{x("@interface").set({pristine:!0,private:!0,lock:!0}),ee("@interface","instance","name","set")});function je(e){const t=e.at("params",e);return t instanceof h?t:new h(t??[])}function me(){m===2&&(m=1,v.forEach(e=>e()),globalThis.installMsjsCoreExtensions(),m=0,_.sr=_.rr=P.$c)}async function X(e){if(D.has("src-"+e))return;D.add("src-"+e);const t=C?.at("modules")?.at(e),n=ne(t?.at("integrity"));if(n){if(D.has(n))return;D.add(n)}else{if(globalThis.msjsHasModMeta)throw new Error(`loadModule: Refusing unverified module "${e}"`);console.log(`loadModule WARNING: Module "${e}" is unverified`)}e=Me(e,t);const s=await re(e,{integrity:n});if(s instanceof Error){for(const r of t?.at("featpro")?.values()||[])k.get(r)?.reject(s);throw s}if(t){const r=Symbol();t.set("mid",r),B.set(n,t),B.set(r,t)}const o=typeof Blob=="function"&&typeof o?.createObjectURL=="function"?o.createObjectURL(new Blob([new TextEncoder().encode(s)],{type:"application/javascript"})):`data:application/javascript;base64,${btoa(s)}`,c=await import(o);o.startsWith("blob:")&&o.revokeObjectURL(o),globalThis.msjsHasModMeta&&c.loadMsjs&&c.loadMsjs(t?.mid)}function we(){console.log(g)}function ye(){const e=function(){},t=function(d){switch({op:d}=R({rr:t,op:d}),d){case"op":return"load";case"rr":case"sr":return e;case"rt":case"st":return"@module"}};let n,s;const o=p=>V(p,t),c=G.bind({sr:e,st:"@module"}),r=()=>n??=new h,a=()=>s??=new h;return $(e,"msjsType","@module"),Object.defineProperties(e,{p:{get:r,enumerable:!0},t:{get:a,enumerable:!0}}),$(t,{sr:e,st:"@module",rr:e,rt:"@module",msjsType:"@dispatch",octx:P.$u,op:"load",mp:P.$u,b:o,sm:c}),Object.defineProperties(t,{p:{get:r,enumerable:!0},t:{get:a,enumerable:!0}}),{d:t,m:e,ls:Ne,na:Le}}v.push(()=>{x("@module").set({pristine:!0,private:!0,lock:!0})});function $e(e,t){const n={cd:e,od:t},s=n.bfn=Te.bind(n);return $(s,"msjsType","@code")}function Y(e,t){const n="@function",s={},o={octx:s,op:"call",handler:{code:e,type:n,op:"call"}};t!==void 0&&$(s,"ps",t);const c=o.bfn=Ee.bind(o);return o.sm=G.bind({sr:c,st:n}),$(c,"msjsType",n)}v.push(()=>{x("@code").set({pristine:!0,private:!0,lock:!0,handlers:{run:!1,fn:!1}}),x("@function").set({pristine:!0,private:!0,lock:!0,handlers:{call:!1,fn:!1}}),x("@handler").set({pristine:!0,private:!0,lock:!0})});function Me(e,t){const n=t?.at("url");if(n)return n;const s=C.at("prefixMap");let o=["",0];for(const[a,p]of s.entries()){const d=a.length;d>o[1]&&e.startsWith(a)&&(o=[p,d])}e=o[0]+e.substring(o[1]);const c=t?.at("version"),[,r]=c&&c.match(/(\d+)/)||[];if(c&&r!==void 0){const[,a,p]=e.match(/(.*\/)?(.*)(?:(?:\.esm)?\.js)?$/);e=`${a}${p}/${r}/${p}@${c}`}return e.endsWith(".js")||(e+=".esm.js"),e}function Te(e,t){const n=R({rr:this.bfn,op:e,mp:t}),{op:s,mp:o,hasElse:c,elseExpr:r}=n;if(s==="run")return this.cd(this.od);switch(s){case U:return;case K:i={code:this.cd};return;case"fn":return Y(this.cd,o)}if(c)return O(r);throw new TypeError(`No Mesgjs handler found for "@code(${s})"`)}function ke(e,t,n){const{op:s,mp:o,elseExpr:c}=R({rr:this.bfn}),{octx:r,handler:a,sm:p}=t;switch(s){case"dop":return t.op;case"ht":return a.type;case"js":return r.js;case"log":console.dir(this.bfn,{depth:null});return;case"mop":return e.op;case"redis":{const d=o.has("else")?o.at("else"):c,j=o.at("type")||a.type;if(!L(a.type).has(j))return O(d);const w=o.has("op")?o.at("op"):a.op,u=je(o),E=z(j,w,j===a.type&&w===a.op);return!E||!o.has("op")&&E.op!==w?O(d):N(e,{octx:r,op:w,handler:E,sm:p},u)}case"return":throw this.bfn._capture=!0,new J("return",o.at(0));case"rr":return e.rr;case"rt":return e.rt;case"sr":return e.sr;case"st":return e.st}return O(c)}function xe(...e){return this.bfn("call",new h([...e]))}function Ee(e,t){const n=R({rr:this.bfn,op:e,mp:t}),{op:s,mp:o,hasElse:c,elseExpr:r}=n;if(s==="call")return N(n,this,o);switch(s){case"fn":return Y(this.handler.code,o);case"jsfn":return this.jsFn||=xe.bind(this)}if(c)return O(r);throw new TypeError(`No Mesgjs handler found for "@function(${s})"`)}function Se(e,t){const n=this.name,{op:s,mp:o,hasElse:c,elseExpr:r}=R({rr:this.bfn,op:e,mp:t});switch(s){case"instance":return F(n,o);case"name":return n;case"set":return Z(n,o,this.isFirst)}if(c)return O(r);throw new TypeError(`No Mesgjs handler found for "@interface(${s})"`)}function G(e,t,n){e?.msjsType||(e=P.$toMsjs(e)),f={sr:this.sr,st:this.st,rr:e,op:t,mp:n};let s;try{s=e()}finally{f=void 0}return s}function Z(e,t,n){if(e[0]==="@"&&m!==1)throw new TypeError(`Cannot configure Mesgjs interface "${e}" after runtime initialization`);const s=g[e];if(t instanceof h&&(t=t.storage),t.once&&!n||t.pristine&&!s.pristine)throw new TypeError(`Mesgjs interface "${e}" is not pristine`);if(s.pristine=!1,s.locked)throw new TypeError(`Cannot change locked Mesgjs interface "${e}"`);if(t.chain){if(s.chain.size)throw new TypeError(`Cannot change chain for Mesgjs interface "${e}"`);if(s.refd)throw new TypeError(`Cannot set chain for active Mesgjs interface "${e}"`);const r=new Set(Object.values(t.chain.storage||t.chain||[]));for(const a of r){if(!g[a])throw new ReferenceError(`Mesgjs interface "${e}" references unknown interface "${a}"`);if(g[a].final)throw new TypeError(`Mesgjs interface "${e}" tries to extend final interface "${a}"`);g[a].refd=!0}s.chain=r}const o=t.handlers||{};for(const[r,a]of o instanceof h?o.entries():Object.entries(o))typeof a=="function"?a.msjsType==="@code"?(i=void 0,a(K),i?.code&&$(s.handlers[r]=i.code,"msjsType","@handler")):s.handlers[r]=a:a===!1&&(s.handlers[r]=!1);i=void 0;const c=t.cacheHints||{};for(const[r,a]of c instanceof h?c.entries():Object.entries(c))switch(a){case!0:case!1:case"pin":s.handlers[r]&&(s.handlers[r].cache=a);break}t.init&&(s.init=t.init),t.abstract&&(s.abstract=!0),t.final&&(s.final=!0),t.lock&&(s.locked=!0),t.once&&(s.once=!0),t.singleton&&(s.singleton=!0)}function Oe(e){if(globalThis.msjsHasModMeta)return;if(e instanceof h)C.push(He(e.toSLID()));else if(typeof e=="object")C.push(ve(JSON.stringify(e)));else return;$(globalThis,{msjsHasModMeta:!0,msjsNoSelfLoad:!0}),ce(C.at("modules"));const t=F("@promise"),n=[];k.set("@loaded",t);for(const s of C.at("modules").entries())s[1].at("defLoad")||n.push(X(s[0]));t.allSettled(...n)}function ee(e,...t){const n=g[e]?.handlers;n&&t.forEach(s=>n[s]=!1)}function Ce(e,t){if(t===void 0){const s=g[e];return s&&!s.private?[...Object.keys(s.handlers)]:void 0}const n=z(e,t);if(n)return[n.type,n.op==="@default"?"default":"specific"]}function Re(e,t){if(!g[e]?.private)return t===void 0?g[e]?Array.from(g[e].chain):void 0:L(e).has(t)}return{debugConfig:ue,fcheck:pe,fready:ge,fwait:he,getInstance:fe,getInterface:x,initialize:me,logInterfaces:we,loadModule:X,moduleScope:ye,setModMeta:Oe,typeAccepts:Ce,typeChains:Re}})();$(globalThis,{$f:!1,$gss:new h,$n:null,$t:!0,$u:void 0,$modScope:Ue});export{J as MsjsFlow,De as MsjsFlowError,Ke as calcIntegrity,Ve as debugConfig,Xe as fcheck,re as fetchModule,Ye as fready,Ze as fwait,et as getInstance,tt as getInterface,nt as initialize,Ne as listFromPairs,st as loadModule,rt as logInterfaces,oe as loggedType,Ue as moduleScope,Le as namespaceAt,O as runIfCode,qe as runWhileCode,Ae as sendAnonMessage,ie as senderFLC,ot as setModMeta,$ as setRO,Qe as throwFlow,it as typeAccepts,ct as typeChains};
